# **é¡¹ç›®æ¦‚è¿°**

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªé¢å‘å¼€å‘è€…çš„ API å¹³å°ï¼Œæä¾› API æ¥å£ä¾›å¼€å‘è€…è°ƒç”¨ã€‚ç”¨æˆ·é€šè¿‡æ³¨å†Œç™»å½•ï¼Œå¯ä»¥å¼€é€šæ¥å£è°ƒç”¨æƒé™ï¼Œå¹¶å¯ä»¥æµè§ˆå’Œè°ƒç”¨æ¥å£ã€‚æ¯æ¬¡è°ƒç”¨éƒ½ä¼šè¿›è¡Œç»Ÿè®¡ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®ç»Ÿè®¡æ•°æ®è¿›è¡Œåˆ†æå’Œä¼˜åŒ–ã€‚ç®¡ç†å‘˜å¯ä»¥å‘å¸ƒæ¥å£ã€ä¸‹çº¿æ¥å£ ã€æ¥å…¥æ¥å£ï¼Œå¹¶å¯è§†åŒ–æ¥å£çš„è°ƒç”¨æƒ…å†µå’Œæ•°æ®ã€‚

## ä¸šåŠ¡æµç¨‹

### **5ä¸ªå­ç³»ç»Ÿï¼š**

1. **æ¨¡æ‹Ÿæ¥å£ç³»ç»Ÿ**ï¼šæä¾›å„ç§æ¨¡æ‹Ÿæ¥å£ä¾›å¼€å‘è€…ä½¿ç”¨å’Œæµ‹è¯•ï¼Œä¾‹å¦‚ï¼Œæä¾›ä¸€ä¸ªéšæœºå¤´åƒç”Ÿæˆæ¥å£ã€‚
2. **åå°ç®¡ç†ç³»ç»Ÿ**ï¼šç®¡ç†å‘˜å¯ä»¥å‘å¸ƒæ¥å£ã€è®¾ç½®æ¥å£çš„è°ƒç”¨æ•°é‡ã€è®¾å®šæ˜¯å¦ä¸‹çº¿æ¥å£ç­‰åŠŸèƒ½ï¼Œä»¥åŠæŸ¥çœ‹ç”¨æˆ·ä½¿ç”¨æ¥å£çš„æƒ…å†µï¼Œä¾‹å¦‚ä½¿ç”¨æ¬¡æ•°ï¼Œé”™è¯¯è°ƒç”¨ç­‰ã€‚
3. **ç”¨æˆ·å‰å°ç³»ç»Ÿ**ï¼šæä¾›ä¸€ä¸ªè®¿é—®ç•Œé¢ï¼Œä¾›å¼€å‘è€…æµè§ˆæ‰€æœ‰çš„æ¥å£ï¼Œå¯ä»¥è´­ä¹°æˆ–å¼€é€šæ¥å£ï¼Œå¹¶è·å¾—ä¸€å®šé‡çš„è°ƒç”¨æ¬¡æ•°ã€‚
4. **API ç½‘å…³ç³»ç»Ÿ**ï¼šè´Ÿè´£æ¥å£çš„æµé‡æ§åˆ¶ï¼Œè®¡è´¹ç»Ÿè®¡ï¼Œå®‰å…¨é˜²æŠ¤ç­‰åŠŸèƒ½ï¼Œæä¾›ä¸€è‡´çš„æ¥å£æœåŠ¡è´¨é‡ï¼Œå’Œç®€åŒ– API çš„ç®¡ç†å·¥ä½œã€‚
5. **ç¬¬ä¸‰æ–¹è°ƒç”¨ SDK ç³»ç»Ÿ**ï¼šæä¾›ä¸€ä¸ªç®€åŒ–çš„å·¥å…·åŒ…ï¼Œä½¿å¾—å¼€å‘è€…å¯ä»¥æ›´æ–¹ä¾¿åœ°è°ƒç”¨æ¥å£ï¼Œä¾‹å¦‚æä¾›é¢„å°è£…çš„ HTTP è¯·æ±‚æ–¹æ³•ã€æ¥å£è°ƒç”¨ç¤ºä¾‹ç­‰ã€‚

### **é¡¹ç›®å…³é”®é—®é¢˜å’ŒæŒ‘æˆ˜ï¼š**

1. **æ¥å£è®¾è®¡**ï¼šéœ€è¦è®¾è®¡æ¸…æ™°æ˜“ç”¨çš„ API æ¥å£ï¼Œå¹¶ä¸”æä¾›è¯¦ç»†çš„æ¥å£æ–‡æ¡£ï¼Œä»¥æ–¹ä¾¿å¼€å‘è€…ä½¿ç”¨ã€‚
2. **æ€§èƒ½å’Œå¯ç”¨æ€§**ï¼šå¹³å°éœ€è¦æ‰¿è½½å¤§é‡çš„æ¥å£è¯·æ±‚ï¼Œå› æ­¤éœ€è¦è€ƒè™‘åˆ°æ€§èƒ½å’Œå¯ç”¨æ€§é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œè®¾è®¡é«˜æ•ˆçš„æ•°æ®å­˜å‚¨å’Œæ£€ç´¢ç­–ç•¥ï¼Œç¡®ä¿ API ç½‘å…³çš„é«˜æ€§èƒ½ç­‰ã€‚
3. **å®‰å…¨**ï¼šå¹³å°éœ€è¦é˜²æ­¢å„ç§å®‰å…¨æ”»å‡»ï¼Œä¾‹å¦‚ DDOS æ”»å‡»ï¼Œä¹Ÿéœ€è¦ä¿æŠ¤ç”¨æˆ·çš„éšç§å’Œæ•°æ®å®‰å…¨ã€‚
4. **è®¡è´¹å’Œæµé‡æ§åˆ¶**ï¼šéœ€è¦è®¾è®¡åˆç†çš„è®¡è´¹ç­–ç•¥å’Œæµé‡æ§åˆ¶æœºåˆ¶ï¼Œä»¥ç¡®ä¿å¹³å°çš„ç¨³å®šè¿è¡Œå’Œæ”¶å…¥æ¥æºã€‚
5. **æ˜“ç”¨æ€§å’Œç”¨æˆ·ä½“éªŒ**ï¼šéœ€è¦ä¸ºå¼€å‘è€…æä¾›ç®€å•æ˜“ç”¨çš„æ¥å£è°ƒç”¨å·¥å…·å’Œå‹å¥½çš„ç”¨æˆ·ç•Œé¢ï¼Œæä¾›ä¼˜è´¨çš„ç”¨æˆ·ä½“éªŒã€‚

ğŸ’¡Â **åœ¨è°ƒç”¨è¿™ä¸ªæ¥å£æ—¶éœ€è¦è€ƒè™‘ä»¥ä¸‹é—®é¢˜ï¼š**

1. éœ€è¦è€ƒè™‘è®¿é—®æƒé™çš„é—®é¢˜ï¼šç”¨æˆ·æ˜¯å¦å¯ä»¥éšæ„è®¿é—®æ•°æ®åº“å’Œæ¥å£ã€‚
2. éœ€è¦æ·»åŠ è®¡è´¹åŠŸèƒ½ï¼Œç»Ÿè®¡ç”¨æˆ·è°ƒç”¨æ¬¡æ•°ï¼Œå¹¶è€ƒè™‘é™æµæˆ–æµé‡ä¿æŠ¤æªæ–½ã€‚
3. éœ€è¦è€ƒè™‘å¦‚ä½•æœ‰æ•ˆåœ°ç®¡ç†ç”¨æˆ·ã€‚(ä¾‹å¦‚ï¼Œå¦‚æœç”¨æˆ·æ¬ è´¹æˆ–è€…æ˜¯é™Œç”Ÿäººè°ƒç”¨æ¥å£ï¼Œæˆ‘ä»¬éœ€è¦åŠæ—¶å‘ç°å¹¶é‡‡å–æªæ–½)

 **ğŸ§° API ç½‘å…³ï¼Ÿ**

API ç½‘å…³çš„ä¸»è¦ä½œç”¨æ˜¯ä¸ºå¤šä¸ªæ¥å£æä¾›ä¿æŠ¤ï¼Œå¹¶é›†ä¸­è¿›è¡Œè®¡è´¹ã€å¥å…¨æ—¥å¿—ç­‰é€»è¾‘å¤„ç†ã€‚ç±»ä¼¼äºæˆ‘ä»¬å»ç«è½¦ç«™åé«˜é“ä¸€æ ·ï¼Œæ— è®ºæ˜¯å»å“ªä¸ªç«™å°åå“ªä¸ªç«è½¦ï¼Œéƒ½éœ€è¦å…ˆé€šè¿‡æ£€ç¥¨å£è¿›è¡Œé›†ä¸­çš„æ£€ç¥¨ã€‚

ä¸æˆ‘ä»¬ç¨‹åºä¸­çš„ AOP ä¸åŒï¼ŒAPI ç½‘å…³æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æœåŠ¡ï¼Œéœ€è¦å•ç‹¬å¼€é€šã€‚

ğŸª”Â  **SDKï¼Ÿ**

SDK æ˜¯è½¯ä»¶å¼€å‘å·¥å…·åŒ…çš„ç¼©å†™ï¼Œæ˜¯ä¸€ç§ä¸ºè½¯ä»¶å¼€å‘è€…æä¾›æ”¯æŒçš„ä¸€ç³»åˆ—å·¥å…·ã€æ¥å£å’Œè§„èŒƒçš„é›†åˆã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚è…¾è®¯äº‘æä¾›äº†ä¸€äº›æ¥å£ï¼Œæ¯”å¦‚åˆ›å»º VPC ç­‰ï¼Œå¦‚æœå¼€å‘è€…ç›´æ¥å‘è…¾è®¯äº‘æœåŠ¡å™¨å‘è¯·æ±‚ï¼Œéœ€è¦è¾“å…¥å¯†é’¥ã€åšç­¾åè®¤è¯ç­‰æ“ä½œï¼Œéå¸¸ç¹çã€‚å› æ­¤ï¼Œåœ¨æ„å»ºç¬¬ä¸‰æ–¹ API å¹³å°æ—¶ï¼Œä¸€èˆ¬éƒ½ä¼šæä¾›ä¸€å¥— SDKï¼Œè®©ä½¿ç”¨è€…èƒ½å¤Ÿè½»æ¾åœ°è°ƒç”¨æ¥å£ï¼Œæ— éœ€è‡ªå·±ç¼–å†™å’Œå°è£… HTTP è¯·æ±‚ã€‚å¯ä»¥æŠŠ SDK ç†è§£ä¸º Java è¯­æ³•ä¸­çš„å·¥å…·åŒ…ï¼Œä½¿ç”¨è€…åªéœ€è¦æœ€å°‘é‡çš„ä»£ç å³å¯è°ƒç”¨æ¥å£ï¼Œå¦‚æœä¸ç†è§£ SDKï¼Œéœ€è¦åŠ å¼º Java è¯­æ³•çš„å­¦ä¹ ã€‚

### éœ€æ±‚åˆ†æ

**èƒŒæ™¯ï¼š**

1. å‰ç«¯å¼€å‘éœ€è¦ç”¨åˆ°åå°æ¥å£
2. ä½¿ç”¨ç°æˆçš„ç³»ç»Ÿçš„åŠŸèƒ½ -Â [å…è´¹APIæ¥å£å¹³å°](http://api.btstu.cn/)

**åšä¸€ä¸ª API æ¥å£å¹³å°ï¼š**

1. ç®¡ç†å‘˜å¯ä»¥å¯¹æ¥å£ä¿¡æ¯è¿›è¡Œå¢åˆ æ”¹æŸ¥
2. ç”¨æˆ·å¯ä»¥è®¿é—®å‰å°,æŸ¥çœ‹æ¥å£ä¿¡æ¯

**å…¶ä»–è¦æ±‚ï¼š**

1. é˜²æ­¢æ”»å‡»(å®‰å…¨æ€§)
2. ä¸èƒ½éšä¾¿è°ƒç”¨(é™åˆ¶ã€å¼€é€š)
3. **ç»Ÿè®¡è°ƒç”¨æ¬¡æ•°**
4. è®¡è´¹
5. æµé‡ä¿æŠ¤
6. API æ¥å…¥

# é¡¹ç›®åˆå§‹åŒ–

## æ•°æ®åº“è¡¨

### æ¥å£ä¿¡æ¯è¡¨


| **æ¥å£ä¿¡æ¯è¡¨(interface_info)** |  |  |
| --- | --- | --- |
| **å­—æ®µ** | **è¯´æ˜** | **ç±»å‹** |
| id | ç”¨æˆ· id(ä¸»é”®) | bigint |
| name | åç§° | varchar(256) |
| description | æè¿° | varchar(256) |
| url | æ¥å£åœ°å€ | varchar(512) |
| requestHeader | è¯·æ±‚å¤´ | text |
| responseHeader | å“åº”å¤´ | text |
| status | æ¥å£çŠ¶æ€ï¼ˆ0-å…³é—­ï¼Œ1-å¼€å¯ï¼‰ | int |
| method | è¯·æ±‚ç±»å‹ | varchar(256) |
| userId | åˆ›å»ºäºº | bigint |
| createTime | åˆ›å»ºæ—¶é—´ | datetime |
| updateTime | æ›´æ–°æ—¶é—´ | datetime |
| isDelete | æ˜¯å¦åˆ é™¤(0-æœªåˆ , 1-å·²åˆ ) | tinyint |

```sql
-- æ¥å£ä¿¡æ¯
create table if not exists yuapi.`interface_info`
(
  `id` bigint not null auto_increment comment 'ä¸»é”®' primary key,
  `name` varchar(256) not null comment 'åç§°',
  `description` varchar(256) null comment 'æè¿°',
  `url` varchar(512) not null comment 'æ¥å£åœ°å€',
  `requestHeader` text null comment 'è¯·æ±‚å¤´',
  `responseHeader` text null comment 'å“åº”å¤´',
  `status` int default 0 not null comment 'æ¥å£çŠ¶æ€ï¼ˆ0-å…³é—­ï¼Œ1-å¼€å¯ï¼‰',
  `method` varchar(256) not null comment 'è¯·æ±‚ç±»å‹',
  `userId` bigint not null comment 'åˆ›å»ºäºº',
  `createTime` datetime default CURRENT_TIMESTAMP not null comment 'åˆ›å»ºæ—¶é—´',
  `updateTime` datetime default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment 'æ›´æ–°æ—¶é—´',
  `isDelete` tinyint default 0 not null comment 'æ˜¯å¦åˆ é™¤(0-æœªåˆ , 1-å·²åˆ )'
) comment 'æ¥å£ä¿¡æ¯';

```

## å‰ç«¯åˆå§‹åŒ–

```jsx
# å®‰è£…è„šæ‰‹æ¶
npm install -g @ant-design/pro-cli@3.1.0
# å®‰è£… echarts
npm install --save echarts-for-react
```

**å‰ç«¯ä»£ç è‡ªåŠ¨ç”Ÿæˆ**

å¦‚ä½•å®ç°æ¥å£çš„è‡ªåŠ¨ç”Ÿæˆï¼šå¦‚æœåç«¯å·²ç»å®šä¹‰äº†å„ç§æ¥å£ï¼Œä½¿ç”¨ oneapi æ’ä»¶æä¾›åŸºäºå…¶è§„èŒƒçš„æ–‡æ¡£æ¥åŒæ­¥è¿™äº›ä¿¡æ¯ã€‚

ç®€å•åœ°è¯´ï¼Œoneapi æ˜¯ä¸€ç§æ¥å£æ–‡æ¡£çš„è§„èŒƒï¼Œå¯ä»¥ç†è§£ä¸ºæ¥å£æ–‡æ¡£çš„æ ¼å¼æˆ–è€…è§„åˆ™ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„ Swagger è¿™ç§åç«¯æ¥å£æ–‡æ¡£ï¼Œå°±æ˜¯éµå¾ªäº† openapi è§„èŒƒã€‚

![image.png](/note_img/image.png)

ä½¿ç”¨openapiæä¾›çš„jsonæ ¼å¼æ¥å£æ–‡æ¡£ï¼Œåœ¨ `config.ts` ä¸­å¼•ç”¨æä¾›çš„æ–‡æ¡£

![image.png](/note_img/image%201.png)

è¿è¡Œ `package.json`ä¸­çš„ `"openapi": "max openapi"` ä¼šè‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£

# åç«¯å¼€å‘

## æ¨¡æ‹Ÿæ¥å£ qianapi-interface

å…ˆæ¥çœŸå®åœ°å‘å¸ƒä¸€ä¸ªç»™å¼€å‘è€…æä¾›çš„æ¥å£ï¼Œåˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿæ¥å£é¡¹ç›®æä¾›ä¸‰ä¸ªæ¨¡æ‹Ÿæ¥å£

1. GET
2. POSTï¼ˆurlä¼ å‚ï¼‰
3. POSTï¼ˆrestfulä¼ å‚ï¼‰

```java
package com.qian.qianapiinterface.controller;
import com.qianapi.qianapiclientsdk.model.User;

@RestController
@RequestMapping("/name")
public class NameController {

    @GetMapping("/")
    public String getName(String name){
        return "åå­—ä¸º"+name;
    }

    @PostMapping("/")
    public String getNameByPost(@RequestParam String name) {
        return "POST ä½ çš„åå­—æ˜¯" + name;
    }

    @PostMapping("/user")
    public String getUserName(@RequestBody User user){
        return "ä¼ å‚ åå­—ä¸º"+user.getName();
    }
}
```

åœ¨ application.yml æŒ‡å®šåç«¯é¡¹ç›®çš„ç«¯å£å·ä¸º 8123 ï¼ŒæŒ‡å®šå…¨å±€æ¥å£åœ°å€ï¼ŒåŠ ä¸€ä¸ª apiå‰ç¼€ã€‚

```yaml
server:
  port: 8123
  servlet:
    context-path: /api
```

å¯åŠ¨é¡¹ç›®ï¼Œè°ƒç”¨æ¥å£[http://localhost:8123/api/name/?name=wyx](http://localhost:8123/api/name/?name=yupi%E3%80%82) è°ƒç”¨çš„GETè¯·æ±‚å¯ä»¥è·å¾—â€œåå­—ä¸ºwyxâ€ï¼Œä½†å¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œæ€»ä¸è‡³äºæ¯æ¬¡éƒ½åœ¨æµè§ˆå™¨åœ°å€æ è¾“å…¥æ¥å£åœ°å€æ¥è°ƒç”¨ï¼Œé€šå¸¸ä¼šé€‰æ‹©åœ¨åç«¯è°ƒç”¨ç¬¬ä¸‰æ–¹ APIï¼Œå› ä¸ºè¿™æ ·å¯ä»¥é¿å…åœ¨å‰ç«¯æš´éœ²è¯¸å¦‚å¯†ç è¿™æ ·çš„æ•æ„Ÿä¿¡æ¯ã€‚

### **è°ƒç”¨æ¥å£çš„æ–¹å¼**

é€šå¸¸å¼€å‘è€…åœ¨åç«¯è°ƒç”¨ç¬¬ä¸‰æ–¹API

**HTTP è°ƒç”¨æ–¹å¼ï¼š**

1. HttpClient
2. RestTemplate
3. ç¬¬ä¸‰æ–¹åº“ï¼ˆOKHTTPã€Hutoolï¼‰

https://www.hutool.cn/docs/#/

```java
/**
 * è°ƒç”¨ç¬¬ä¸‰æ–¹æ¥å£çš„å®¢æˆ·ç«¯
 */
public class QianApiClient {
    // ä½¿ç”¨GETæ–¹æ³•ä»æœåŠ¡å™¨è·å–åç§°ä¿¡æ¯
    public String getNameByGet(String name) {
        // å¯ä»¥å•ç‹¬ä¼ å…¥httpå‚æ•°ï¼Œè¿™æ ·å‚æ•°ä¼šè‡ªåŠ¨åšURLç¼–ç ï¼Œæ‹¼æ¥åœ¨URLä¸­
        HashMap<String, Object> paramMap = new HashMap<>();
        // å°†"name"å‚æ•°æ·»åŠ åˆ°æ˜ å°„ä¸­
        paramMap.put("name", name);
        // ä½¿ç”¨HttpUtilå·¥å…·å‘èµ·GETè¯·æ±‚ï¼Œå¹¶è·å–æœåŠ¡å™¨è¿”å›çš„ç»“æœ
        String result= HttpUtil.get("http://localhost:8123/api/name/", paramMap);
        // è¿”å›æœåŠ¡å™¨è¿”å›çš„ç»“æœ
        return result;
    }
    
    // ä½¿ç”¨POSTæ–¹æ³•ä»æœåŠ¡å™¨è·å–åç§°ä¿¡æ¯
    public String getNameByPost(@RequestParam String name) {
        // å¯ä»¥å•ç‹¬ä¼ å…¥httpå‚æ•°ï¼Œè¿™æ ·å‚æ•°ä¼šè‡ªåŠ¨åšURLç¼–ç ï¼Œæ‹¼æ¥åœ¨URLä¸­
        HashMap<String, Object> paramMap = new HashMap<>();
        paramMap.put("name", name);
        // ä½¿ç”¨HttpUtilå·¥å…·å‘èµ·POSTè¯·æ±‚ï¼Œå¹¶è·å–æœåŠ¡å™¨è¿”å›çš„ç»“æœ
        String result= HttpUtil.post("http://localhost:8123/api/name/", paramMap);
        return result;
    }

    // ä½¿ç”¨POSTæ–¹æ³•å‘æœåŠ¡å™¨å‘é€Userå¯¹è±¡ï¼Œå¹¶è·å–æœåŠ¡å™¨è¿”å›çš„ç»“æœ
    public String getUserNameByPost(@RequestBody User user) {
        // å°†Userå¯¹è±¡è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
        String json = JSONUtil.toJsonStr(user);
        // ä½¿ç”¨HttpRequestå·¥å…·å‘èµ·POSTè¯·æ±‚ï¼Œå¹¶è·å–æœåŠ¡å™¨çš„å“åº”
        HttpResponse httpResponse = HttpRequest.post("http://localhost:8123/api/name/")
                .body(json) // å°†JSONå­—ç¬¦ä¸²è®¾ç½®ä¸ºè¯·æ±‚ä½“
                .execute(); // æ‰§è¡Œè¯·æ±‚
        // æ‰“å°æœåŠ¡å™¨è¿”å›çš„çŠ¶æ€ç 
        System.out.println(httpResponse.getStatus());
        // è·å–æœåŠ¡å™¨è¿”å›çš„ç»“æœ
        String result = httpResponse.body();
        // è¿”å›æœåŠ¡å™¨è¿”å›çš„ç»“æœ
        return result;
    }
}

```

## APIç­¾åè®¤è¯

æˆ‘ä»¬ä¸ºå¼€å‘è€…æä¾›äº†ä¸€ä¸ªæ¥å£ï¼Œå´å¯¹è°ƒç”¨è€…ä¸€æ— æ‰€çŸ¥ã€‚å¦‚æœæ”»å‡»è€…ç–¯ç‹‚åœ°è¯·æ±‚è¿™ä¸ªæ¥å£ï¼Œä¼šå½±å“æ­£å¸¸ç”¨æˆ·çš„ä½¿ç”¨ã€‚å¦‚æœåœ¨åæœŸä¸šåŠ¡æ‰©å¤§ï¼Œå¯èƒ½è¿˜éœ€è¦æ”¶è´¹ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»çŸ¥é“è°åœ¨è°ƒç”¨æ¥å£ï¼Œå¹¶ä¸”ä¸èƒ½è®©æ— æƒé™çš„äººéšæ„è°ƒç”¨ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦è®¾è®¡ä¸€ä¸ªæ–¹æ³•ï¼Œæ¥ç¡®å®šè°åœ¨è°ƒç”¨æ¥å£ã€‚åœ¨ä¹‹å‰å¼€å‘åç«¯æ—¶ï¼Œä¼šåˆ©ç”¨sessionè¿›è¡Œä¸€äº›æƒé™æ£€æŸ¥åˆ¤æ–­æ˜¯å¦æ˜¯ç®¡ç†å‘˜ã€‚ä½†æ˜¯è°ƒç”¨è€…æ²¡æœ‰ç™»å½•æ“ä½œï¼Œè¯¥æ€ä¹ˆåšï¼Œè¿™æ—¶å€™è¦ç”¨åˆ°APç­¾åè®¤è¯çš„æœºåˆ¶ã€‚

API ç­¾åè®¤è¯ä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªè¿‡ç¨‹ã€‚ç¬¬ä¸€ä¸ªæ˜¯ç­¾å‘ç­¾åï¼Œç¬¬äºŒä¸ªæ˜¯ä½¿ç”¨ç­¾åæˆ–æ ¡éªŒç­¾åã€‚è¿™å°±åƒä¸€äº›çŸ­ä¿¡æ¥å£çš„ key ä¸€æ ·ã€‚

1. ä¿è¯å®‰å…¨æ€§ï¼Œä¸èƒ½éšä¾¿ä¸€ä¸ªäººè°ƒç”¨
2. é€‚ç”¨äºæ— éœ€ä¿å­˜ç™»å½•æ€çš„åœºæ™¯ã€‚åªè®¤ç­¾åï¼Œä¸å…³æ³¨ç”¨æˆ·ç™»å½•æ€ã€‚

### ç®€å•è®¤è¯

- ç»™`QianApiClient` å¢åŠ `accessKey`ä¸`secretKey`å­—æ®µï¼Œåˆ›å»ºä¸€ä¸ªç§æœ‰æ–¹æ³•ï¼Œç”¨äºæ„é€ è¯·æ±‚å¤´åœ¨`HttpResponse` ä¸­æ·»åŠ è¯·æ±‚å¤´

```java
public class QianApiClient {

    private String accessKey;

    private String secretKey;

    public YuApiClient(String accessKey, String secretKey) {
        this.accessKey = accessKey;
        this.secretKey = secretKey;
    }

    public String getNameByGet(String name) {

    }

    public String getNameByPost(@RequestParam String name) {

    }

    // åˆ›å»ºä¸€ä¸ªç§æœ‰æ–¹æ³•ï¼Œç”¨äºæ„é€ è¯·æ±‚å¤´
    private Map<String, String> getHeaderMap() {
        // åˆ›å»ºä¸€ä¸ªæ–°çš„ HashMap å¯¹è±¡
        Map<String, String> hashMap = new HashMap<>();
        // å°† "accessKey" å’Œå…¶å¯¹åº”çš„å€¼æ”¾å…¥ map ä¸­
        hashMap.put("accessKey", accessKey);
        // å°† "secretKey" å’Œå…¶å¯¹åº”çš„å€¼æ”¾å…¥ map ä¸­
        hashMap.put("secretKey", secretKey);
        // è¿”å›æ„é€ çš„è¯·æ±‚å¤´ map
        return hashMap;
    }

    public String getUserNameByPost(@RequestBody User user) {
        String json = JSONUtil.toJsonStr(user);
        HttpResponse httpResponse = HttpRequest.post("http://localhost:8123/api/name/user")
                **// æ·»åŠ å‰é¢æ„é€ çš„è¯·æ±‚å¤´**
                **.addHeaders(getHeaderMap())**
                .body(json)
                .execute();
        System.out.println(httpResponse.getStatus());
        String result = httpResponse.body();
        System.out.println(result);
        return result;
    }
}

```

- `NameController` ç›¸å½“äºåç«¯ï¼Œå¼€å‘è€…è°ƒç”¨useræ¥å£ï¼Œè¯·æ±‚çš„æ•°æ®éœ€è¦å¸¦ä¸Š`accessKey`ä¸`secretKey`å­—æ®µ

```java
@PostMapping("/user")
public String getUserNameByPost(@RequestBody User user, HttpServletRequest request) {
    // ä»è¯·æ±‚å¤´ä¸­è·å–åä¸º "accessKey" çš„å€¼
    String accessKey = request.getHeader("accessKey");
    // ä»è¯·æ±‚å¤´ä¸­è·å–åä¸º "secretKey" çš„å€¼
    String secretKey = request.getHeader("secretKey");
    // å¦‚æœ accessKey ä¸ç­‰äº "yupi" æˆ–è€… secretKey ä¸ç­‰äº "abcdefgh"
    if (!accessKey.equals("yupi") || !secretKey.equals("abcdefgh")){
        // æŠ›å‡ºä¸€ä¸ªè¿è¡Œæ—¶å¼‚å¸¸ï¼Œè¡¨ç¤ºæƒé™ä¸è¶³
        throw new RuntimeException("æ— æƒé™");
    }
    // å¦‚æœæƒé™æ ¡éªŒé€šè¿‡ï¼Œè¿”å› "POST ç”¨æˆ·åå­—æ˜¯" + ç”¨æˆ·å
    return "POST ç”¨æˆ·åå­—æ˜¯" + user.getUsername();
}

```

### **æ¥å£é˜²å¾¡æªæ–½ï¼š**

1. è¯·æ±‚çš„ç”¨æˆ·éœ€æ±‚ä»¥åŠæ˜¯å¦çœŸå®å­˜åœ¨
    - **å‚æ•° 1ï¼š**accessKeyï¼šè°ƒç”¨çš„æ ‡è¯† userA, userBï¼ˆå¤æ‚ã€æ— åºã€æ— è§„å¾‹ï¼‰
    - **å‚æ•° 2ï¼š**ç”¨æˆ·è¯·æ±‚å†…å®¹
2. è¯·æ±‚å‚æ•°æ˜¯å¦è¢«ç¯¡æ”¹
    - **å‚æ•° 3ï¼š**secretKeyï¼šå¯†é’¥ï¼ˆå¤æ‚ã€æ— åºã€æ— è§„å¾‹ï¼‰**è¯¥å‚æ•°ä¸èƒ½æ”¾åˆ°è¯·æ±‚å¤´ä¸­**
        
        (ç±»ä¼¼ç”¨æˆ·åå’Œå¯†ç ï¼ŒåŒºåˆ«ï¼šakã€sk æ˜¯æ— çŠ¶æ€çš„ï¼Œä¸ä¼šç®¡ä¹‹å‰æ¥æ²¡æ¥è¿‡)
        
    - **å‚æ•° 4ï¼š**ç­¾å
        
        ç”¨æˆ·å‚æ•° + secretKey => ç­¾åç”Ÿæˆç®—æ³•ï¼ˆMD5ã€HMacã€Sha1ï¼‰ => ä¸å¯è§£å¯†çš„å€¼
        
        æœåŠ¡ç«¯ç”¨ä¸€æ¨¡ä¸€æ ·çš„ï¼ˆå‚æ•°+secretKeyï¼‰å’Œç®—æ³•å»ç”Ÿæˆç­¾åï¼Œåªè¦å’Œç”¨æˆ·ä¼ çš„çš„ä¸€è‡´ï¼Œå°±è¡¨ç¤ºè¯·æ±‚æ˜¯å¯ä¿¡çš„
        
    
    <aside>
    â¡ï¸
    
    è¯·æ±‚æºå¸¦å‚æ•°AccessKeyå’ŒSignï¼Œåªæœ‰æ‹¥æœ‰åˆæ³•çš„èº«ä»½AccessKeyå’Œæ­£ç¡®çš„ç­¾åSignæ‰èƒ½æ”¾è¡Œã€‚
    è¿™æ ·å°±è§£å†³äº†èº«ä»½éªŒè¯å’Œå‚æ•°ç¯¡æ”¹é—®é¢˜ï¼Œå³ä½¿è¯·æ±‚å‚æ•°è¢«åŠ«æŒï¼Œç”±äºè·å–ä¸åˆ°SecretKeyï¼ˆä»…ä½œæœ¬åœ°åŠ å¯†ä½¿ç”¨ï¼Œä¸å‚ä¸ç½‘ç»œä¼ è¾“ï¼‰ï¼Œæ— æ³•ä¼ªé€ åˆæ³•çš„è¯·æ±‚ã€‚
    
    </aside>
    
3. æ˜¯å¦å­˜åœ¨é‡å¤è¯·æ±‚
    - **å‚æ•° 5ï¼š**nonce æŒ‡å”¯ä¸€çš„éšæœºå­—ç¬¦ä¸²ï¼Œç”¨æ¥æ ‡è¯†æ¯ä¸ªè¢«ç­¾åçš„è¯·æ±‚ã€‚
        
        é˜²æ­¢é‡æ”¾æ”»å‡»ï¼ˆè®°å½•æ‰€æœ‰ç”¨è¿‡çš„nonceä»¥é˜»æ­¢å®ƒä»¬è¢«äºŒæ¬¡ä½¿ç”¨ï¼‰
        
4. è¯·æ±‚å‘èµ·æ—¶é—´å¾—åœ¨é™åˆ¶èŒƒå›´å†…
    - **å‚æ•° 6ï¼š** timestamp æ—¶é—´æˆ³ï¼ˆä¼˜åŒ–nonceçš„å­˜å‚¨ï¼‰
        
        å°†è¿‡æœŸçš„nonceåˆ é™¤
        

<aside>
ğŸ’¡

AccessKeyï¼šç”¨äºèº«ä»½éªŒè¯

SecretKeyï¼šç”¨äºé˜²æ­¢å‚æ•°ç¯¡æ”¹

æ—¢è¦ä¼ é€’ç”¨æˆ·è¯·æ±‚å‚æ•°bodyï¼ˆä¸ºäº†è¯·æ±‚å†…å®¹ï¼‰ä¹Ÿè¦ä¼ é€’ï¼ˆå‚æ•°+secretKeyï¼‰åŠ å¯†çš„å†…å®¹ å› ä¸ºåŠ å¯†å‡ºçš„å†…å®¹æœ¬èº«æ˜¯ä¸å¯é€†çš„ å–ä¸å‡ºæ¥body

</aside>

### å®ç°ï¼šé€šè¿‡ http request header å¤´ä¼ é€’å‚æ•°ã€‚

åŸºäºsecretKey**ä¸èƒ½æ”¾åˆ°è¯·æ±‚å¤´ä¸­**ã€éœ€è¦ç»™è¯·æ±‚å‚æ•°åŠ å¯†ã€é˜²æ­¢é‡æ”¾æ”»å‡»ä¸åˆ é™¤è¿‡æœŸè¯·æ±‚

å¯¹è¯·æ±‚å¤´æ•°æ®è¿›è¡Œä¿®æ”¹

```java
/**
 * ç­¾åå·¥å…·
 */
public class SignUtils {
    /**
     * ç”Ÿæˆç­¾å
     * @param hashMap åŒ…å«éœ€è¦ç­¾åçš„å‚æ•°çš„å“ˆå¸Œæ˜ å°„
     * @param secretKey å¯†é’¥
     * @return ç”Ÿæˆçš„ç­¾åå­—ç¬¦ä¸²
     */
    public static String genSign(Map<String, String> hashMap, String secretKey) {
        // ä½¿ç”¨SHA256ç®—æ³•çš„Digester
        Digester md5 = new Digester(DigestAlgorithm.SHA256);
        // æ„å»ºç­¾åå†…å®¹ï¼Œå°†å“ˆå¸Œæ˜ å°„è½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶æ‹¼æ¥å¯†é’¥
        String content = hashMap.toString() + "." + secretKey;
        // è®¡ç®—ç­¾åçš„æ‘˜è¦å¹¶è¿”å›æ‘˜è¦çš„åå…­è¿›åˆ¶è¡¨ç¤ºå½¢å¼
        return md5.digestHex(content);
    }
}

```

- `QianApiClient` æ·»åŠ ç›¸å…³å®‰å…¨æªæ–½

```java
/**
 * è·å–è¯·æ±‚å¤´çš„å“ˆå¸Œæ˜ å°„
 * @param body è¯·æ±‚ä½“å†…å®¹
 * @return åŒ…å«è¯·æ±‚å¤´å‚æ•°çš„å“ˆå¸Œæ˜ å°„
 */
private Map<String, String> getHeaderMap(String body) {
    Map<String, String> hashMap = new HashMap<>();
    hashMap.put("accessKey", accessKey);
    // æ³¨æ„ï¼šä¸èƒ½ç›´æ¥å‘é€å¯†é’¥
    // hashMap.put("secretKey", secretKey);
    // ç”Ÿæˆéšæœºæ•°(ç”Ÿæˆä¸€ä¸ªåŒ…å«100ä¸ªéšæœºæ•°å­—çš„å­—ç¬¦ä¸²)
    hashMap.put("nonce", RandomUtil.randomNumbers(100));
    // è¯·æ±‚ä½“å†…å®¹
    hashMap.put("body", body);
    // å½“å‰æ—¶é—´æˆ³
    // System.currentTimeMillis()è¿”å›å½“å‰æ—¶é—´çš„æ¯«ç§’æ•°ã€‚é€šè¿‡é™¤ä»¥1000ï¼Œå¯ä»¥å°†æ¯«ç§’æ•°è½¬æ¢ä¸ºç§’æ•°ï¼Œä»¥å¾—åˆ°å½“å‰æ—¶é—´æˆ³çš„ç§’çº§è¡¨ç¤º
    // String.valueOf()æ–¹æ³•ç”¨äºå°†æ•°å€¼è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚åœ¨è¿™é‡Œï¼Œå°†è®¡ç®—å¾—åˆ°çš„æ—¶é—´æˆ³ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰è½¬æ¢ä¸ºå­—ç¬¦ä¸²
    hashMap.put("timestamp", String.valueOf(System.currentTimeMillis() / 1000));
    // ç”Ÿæˆç­¾å
    hashMap.put("sign", **SignUtils.genSign**(body, secretKey));
    return hashMap;
}

/**
 * é€šè¿‡POSTè¯·æ±‚è·å–ç”¨æˆ·å
 * @param user ç”¨æˆ·å¯¹è±¡
 * @return ä»æœåŠ¡å™¨è·å–çš„ç”¨æˆ·å
 */
public String getUserNameByPost(@RequestBody User user) {
    // å°†ç”¨æˆ·å¯¹è±¡è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
    String json = JSONUtil.toJsonStr(user);
    HttpResponse httpResponse = HttpRequest.post("http://localhost:8123/api/name/user")
            // æ·»åŠ è¯·æ±‚å¤´
            .addHeaders(getHeaderMap(json))
            // è®¾ç½®è¯·æ±‚ä½“
            .body(json)
            // å‘é€POSTè¯·æ±‚
            .execute();
    // æ‰“å°å“åº”çŠ¶æ€ç 
    System.out.println(httpResponse.getStatus());
    // æ‰“å°å“åº”ä½“å†…å®¹
    String result = httpResponse.body();
    System.out.println(result);
    return result;
}

```

- `NameController` åç«¯å¯¹å‘é€è¿‡æ¥çš„æ•°æ®è¿›è¡Œæ ¡éªŒ

```java
@PostMapping("/user")
public String getUserNameByPost(@RequestBody User user, HttpServletRequest request) {
    // 1.æ‹¿åˆ°è¿™äº”ä¸ªæˆ‘ä»¬å¯ä»¥ä¸€æ­¥ä¸€æ­¥å»åšæ ¡éªŒ,æ¯”å¦‚ accessKey æˆ‘ä»¬å…ˆå»æ•°æ®åº“ä¸­æŸ¥ä¸€ä¸‹
    // ä»è¯·æ±‚å¤´ä¸­è·å–å‚æ•°
    String accessKey = request.getHeader("accessKey");
    String nonce = request.getHeader("nonce");
    String timestamp = request.getHeader("timestamp");
    String sign = request.getHeader("sign");
    String body = request.getHeader("body");
    // ä¸èƒ½ç›´æ¥è·å–ç§˜é’¥
    //        String secretKey = request.getHeader("secretKey");

    // 2.æ ¡éªŒæƒé™,è¿™é‡Œæ¨¡æ‹Ÿä¸€ä¸‹,ç›´æ¥åˆ¤æ–­ accessKey æ˜¯å¦ä¸º"yupi",å®é™…åº”è¯¥æŸ¥è¯¢æ•°æ®åº“éªŒè¯æƒé™
    if (!accessKey.equals("yupi")){
        throw new RuntimeException("æ— æƒé™");
    }

    // 3.æ ¡éªŒä¸€ä¸‹éšæœºæ•°,å› ä¸ºæ—¶é—´æœ‰é™,å°±ä¸å¸¦å¤§å®¶å†åˆ°åç«¯å»å­˜å‚¨äº†,åç«¯å­˜å‚¨ç”¨hashmapæˆ–rediséƒ½å¯ä»¥
    // æ ¡éªŒéšæœºæ•°,æ¨¡æ‹Ÿä¸€ä¸‹,ç›´æ¥åˆ¤æ–­nonceæ˜¯å¦å¤§äº10000
    if (Long.parseLong(nonce) > 10000) {
        throw new RuntimeException("æ— æƒé™");
    }

    // 4 è·å–çš„æ—¶é—´æˆ³-å½“å‰æ—¶é—´æˆ³ å¦‚æœå¤§äº”åˆ†é’Ÿ è¡¨ç¤ºè¶…æ—¶
    if(Math.abs(Long.parseLong(timestamp) - System.currentTimeMillis()) > 5 * 60 * 1000){
        throw new RuntimeException("æ— æƒé™");
    }
    
    // 5 æ ¡éªŒsecretKey é˜²æ­¢å‚æ•°ç¯¡æ”¹
    // TODO å®¢æˆ·ç«¯çš„ secretKey å°±æ˜¯æœåŠ¡ç«¯ç­¾å‘çš„ å®é™…åº”å½“å»æ•°æ®åº“ä¸­æŸ¥æ‰¾accessKeyå¯¹åº”çš„
    String serverSign = SignUtils.genSign(body, "asdfghjkl");
    if(!sign.equals(serverSign)){
        throw new RuntimeException("æ— æƒé™");
    }

    return "POST ç”¨æˆ·åå­—æ˜¯" + user.getUsername();
}
```

## ç”¨æˆ·å®¢æˆ·ç«¯SDKå¼€å‘

**ä¸ºä»€ä¹ˆéœ€è¦ Starterï¼Ÿ**

ä½œä¸ºå¼€å‘è€…ï¼Œå¦‚æœæ¯æ¬¡è°ƒç”¨æ¥å£éƒ½éœ€è¦ç”Ÿæˆæ—¶é—´æˆ³ï¼Œç¼–å†™ç­¾åç®—æ³•ï¼Œç”Ÿæˆéšæœºæ•°ç­‰ç­‰ï¼Œå¯¹å¼€å‘è€…ä¸åˆ©ã€‚å› æ­¤æˆ‘ä»¬è¦æƒ³è®©å¼€å‘è€…èƒ½å¤Ÿä»¥æœ€ç®€å•çš„æ–¹å¼è°ƒç”¨æ¥å£ï¼Œå¼€å‘è€…åªéœ€è¦å…³å¿ƒä¼ é€’å“ªäº›å‚æ•°ä»¥åŠä»–ä»¬çš„å¯†é’¥ã€APPç­‰ä¿¡æ¯ï¼Œå°±è·Ÿè°ƒç”¨è‡ªå·±å†™çš„ä»£ç ä¸€æ ·ç®€å•ã€‚

å¼€å‘ starter çš„å¥½å¤„ï¼šå¼€å‘è€…å¼•å…¥ä¹‹åï¼Œå¯ä»¥ç›´æ¥åœ¨ application.yml ä¸­å†™é…ç½®ï¼Œè‡ªåŠ¨åˆ›å»ºå®¢æˆ·ç«¯ã€‚

**è¿›ä¸€æ­¥è¯´æ˜ï¼š**

ä¸ºäº†æ–¹ä¾¿å¼€å‘è€…çš„è°ƒç”¨ï¼Œæˆ‘ä»¬ä¸èƒ½è®©ä»–ä»¬æ¯æ¬¡éƒ½è‡ªå·±ç¼–å†™ç­¾åç®—æ³•ï¼Œè¿™æ˜¾ç„¶å¾ˆç¹çã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å¼€å‘ä¸€ä¸ªç®€å•æ˜“ç”¨çš„ SDKã€‚å®é™…ä¸Šï¼ŒRPCï¼ˆè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼‰å°±æ˜¯ä¸ºäº†å®ç°è¿™ä¸€ç›®çš„è€Œè®¾è®¡çš„ã€‚

### starter

åœ¨è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°å¼•å…¥ mybatisã€redisã€ swagger æ¥å£æ–‡æ¡£çš„æ—¶å€™ï¼Œéƒ½ä½¿ç”¨äº† starterã€‚

**ä¼˜åŠ¿ï¼š**

- å¯¹äº Redis çš„ starterï¼Œå¯ä»¥ç›´æ¥åœ¨ application.yml é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œç›¸å…³é…ç½®ã€‚æˆ‘ä»¬å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­ç®€å•åœ°å®šä¹‰ä¸€ä¸ªè¿æ¥åˆ° Redis çš„é…ç½®å—
- å¯¹äº Swagger æ¥å£æ–‡æ¡£ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œç›¸åº”çš„é…ç½®ã€‚

ä½¿ç”¨ starter çš„å¥½å¤„å°±æ˜¯ï¼Œå¼€å‘è€…å¼•å…¥åå¯ä»¥ç›´æ¥åœ¨ application.ym ä¸­è¿›è¡Œé…ç½®ï¼Œè‡ªåŠ¨åˆ›å»ºç›¸åº”çš„å®¢æˆ·ç«¯ã€‚è¿™æ ·ä½¿å¾—å¼€å‘è¿‡ç¨‹æ›´åŠ ç®€å•ä¾¿æ·ï¼Œæ— éœ€è¿‡å¤šå…³æ³¨åº•å±‚å®ç°ç»†èŠ‚ï¼Œè€Œæ˜¯ä¸“æ³¨äºé…ç½®å’Œä½¿ç”¨ã€‚

```yaml
spring:
  application:
    name: qianapi-backend
  # DataSource Config
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/qianapi
    username: root
    password: wyx232524
  # session å¤±æ•ˆæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
  session:
    timeout: 86400
    store-type: redis
  # redis é…ç½®
  redis:
    port: 6379
    host: localhost
    database: 0
```

### å¼€å‘æµç¨‹

- **`qianapi-client-sdk` é¡¹ç›®**
    - **ä¿®æ”¹ pom æ–‡ä»¶çš„ç‰ˆæœ¬å·ï¼Œå¹¶åˆ é™¤ build**
    
    ![image.png](/note_img/image%202.png)
    
    ![image.png](/note_img/image%203.png)
    
    - å†™`QianapiClientConfig`é…ç½®ç±»
    
    ç›®æ ‡æ˜¯ä¸ºç”¨æˆ·ç”Ÿæˆä¸€ä¸ªå¯ç”¨çš„å®¢æˆ·ç«¯å¯¹è±¡ï¼Œå¸Œæœ›ç”¨æˆ·èƒ½å¤Ÿé€šè¿‡å¼•å…¥starter çš„æ–¹å¼ç›´æ¥ä½¿ç”¨å®¢æˆ·ç«¯ï¼Œè€Œä¸éœ€è¦æ‰‹åŠ¨åˆ›å»ºï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç¼–å†™ä¸€ä¸ªé…ç½®ç±»ã€‚
    
    ```java
    // é€šè¿‡ @Configuration æ³¨è§£,å°†è¯¥ç±»æ ‡è®°ä¸ºä¸€ä¸ªé…ç½®ç±»,å‘Šè¯‰ Spring è¿™æ˜¯ä¸€ä¸ªç”¨äºé…ç½®çš„ç±»
    @Configuration
    // èƒ½å¤Ÿè¯»å–application.ymlçš„é…ç½®,è¯»å–åˆ°é…ç½®ä¹‹å,æŠŠè¿™ä¸ªè¯»åˆ°çš„é…ç½®è®¾ç½®åˆ°æˆ‘ä»¬è¿™é‡Œçš„å±æ€§ä¸­,
    // è¿™é‡Œç»™æ‰€æœ‰çš„é…ç½®åŠ ä¸Šå‰ç¼€ä¸º"qianapi.client"
    @ConfigurationProperties("qianapi.client")
    // @Data æ³¨è§£æ˜¯ä¸€ä¸ª Lombok æ³¨è§£,è‡ªåŠ¨ç”Ÿæˆäº†ç±»çš„getterã€setteræ–¹æ³•
    @Data
    // @ComponentScan æ³¨è§£ç”¨äºè‡ªåŠ¨æ‰«æç»„ä»¶ï¼Œä½¿å¾— Spring èƒ½å¤Ÿè‡ªåŠ¨æ³¨å†Œç›¸åº”çš„ Bean
    @ComponentScan
    public class QianapiClientConfig{
    
        private String accessKey;
    
        private String secretKey;
    
        @Bean
        public QianapiClient qianapiClient() {
            return new QianapiClient(accessKey, secretKey);
        }
    }
    ```
    
    - **å†™META-INF spring-factories**
        - META - INF æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ç›®å½•ï¼Œç”¨äºå­˜æ”¾åº”ç”¨ç¨‹åºç›¸å…³çš„å…ƒæ•°æ®ï¼ˆmeta - dataï¼‰ã€‚å®ƒæ˜¯ Java æ ‡å‡†çš„ä¸€éƒ¨åˆ†ï¼Œä¸»è¦ç”¨äºå­˜å‚¨é‚£äº›ä¸æ˜¯ Java ç±»æ–‡ä»¶ï¼ˆ.class æ–‡ä»¶ï¼‰çš„èµ„æºã€‚è¿™äº›èµ„æºåŒ…æ‹¬ä½†ä¸é™äºé…ç½®æ–‡ä»¶ã€æœåŠ¡æä¾›è€…é…ç½®ç­‰ï¼Œç”¨äºå¯¹ Java åº”ç”¨ç¨‹åºè¿›è¡Œé¢å¤–çš„å®šä¹‰å’Œé…ç½®ã€‚
        - `spring - factories`æ–‡ä»¶ä½äº META - INF ç›®å½•ä¸‹ï¼Œä¸»è¦ç”¨äºå®ç° Spring Boot ä¸­çš„è‡ªåŠ¨é…ç½®åŠŸèƒ½ï¼Œ**èƒ½å¤Ÿè‡ªåŠ¨åŠ è½½å¹¶åº”ç”¨è¿™äº›è‡ªåŠ¨é…ç½®ç±»**
        
        sdkä¸­è®¾ç½®é…ç½®ç±» ä¼šè‡ªåŠ¨æ ¹æ®è®¾ç½® åŠ è½½`QianapiClientConfig`é…ç½®ç±»
        
        ![image.png](/note_img/image%204.png)
        
        ```java
        # springboot starter  QianapiClientConfig
        org.springframework.boot.autoconfigure.EnableAutoConfiguration=com.qianapi.qianapiclientsdk.QianapiClientConfig
        ```
        
    - **@configurationPropertiesæ³¨è§£** [@ConfigurationProperties](https://www.notion.so/ConfigurationProperties-16552b323dd1803da239c84ac2f6c8dd?pvs=21)
- **`qianapi-interface` é¡¹ç›®-ç”¨äºå¼€å‘è€…è°ƒç”¨æ¥å£æµ‹è¯•**
    - **æ‰“åŒ… å¼•å…¥sdk**
        - ğŸ›**BUG:** ä¸å†æ”¯æŒæºé€‰é¡¹ 5ã€‚è¯·ä½¿ç”¨ 8 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚
            - æ·»åŠ å¦‚ä¸‹ä¸¤è¡Œ
            
            ![image.png](/note_img/image%205.png)
            
        
        **qianapi-client-sdké¡¹ç›®**
        
        ![image.png](/note_img/image%206.png)
        
        - æ‰“åŒ…åçš„mavenåŒ…å­˜æ”¾åœ¨.m2æ–‡ä»¶å¤¹
        
        **qianapi-interfaceé¡¹ç›®**
        
        ![image.png](/note_img/image%207.png)
        
        ![image.png](/note_img/image%208.png)
        
        ç”¨æˆ·å¼•å…¥äº†sdké¡¹ç›®åï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨`QianapiClient`ï¼ŒSpring Boot å°†ä¼šåœ¨åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½å’Œå®ä¾‹åŒ– `QianapiClientConfig`ï¼Œå¹¶å°†å…¶åº”ç”¨äºæˆ‘ä»¬çš„**qianapi-interface**åº”ç”¨ç¨‹åºä¸­ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨è‡ªåŠ¨é…ç½®ç”Ÿæˆçš„ `QianapiClient`å¯¹è±¡ï¼Œè€Œæ— éœ€æ‰‹åŠ¨åˆ›å»ºå’Œé…ç½®ã€‚
        
        æ­¤å¤–`QianapiClientConfig` æ·»åŠ çš„ `@ConfigurationProperties("qianapi.client")` ä¼šè‡ªåŠ¨è¯»å–`application.yml`ä¸­çš„é…ç½®æ·»åŠ åˆ°`QianapiClient`å±æ€§ä¸­
        
        ![image.png](/note_img/image%209.png)
        
- sdk
    
    é…ç½®ç±» `@ConfigurationProperties`å¤–éƒ¨é…ç½®ç»‘å®šåˆ°javaç±»ä¸Š
    
    META-INF æ·»åŠ  `spring - factories`è‡ªåŠ¨åŠ è½½é…ç½®ç±»
    
- interfaceé¡¹ç›®
    
    å¼•å…¥sdk
    
    `application.yml`é…ç½®
    
    ä½¿ç”¨æå‰é…ç½®çš„ç±»
    

## æ¥å£å‘å¸ƒä¸‹çº¿

**å‘å¸ƒæ¥å£(ä»…ç®¡ç†å‘˜å¯æ“ä½œ)**

1. æ ¡éªŒè¯¥æ¥å£æ˜¯å¦å­˜åœ¨
2. åˆ¤æ–­è¯¥æ¥å£æ˜¯å¦å¯ä»¥è°ƒç”¨
3. ä¿®æ”¹æ¥å£æ•°æ®åº“ä¸­çš„çŠ¶æ€å­—æ®µä¸º 1

**ä¸‹çº¿æ¥å£(ä»…ç®¡ç†å‘˜å¯æ“ä½œ)**

1. æ ¡éªŒè¯¥æ¥å£æ˜¯å¦å­˜åœ¨
2. ä¿®æ”¹æ¥å£æ•°æ®åº“ä¸­çš„çŠ¶æ€å­—æ®µä¸º 0

è¿™ä¸¤ä¸ªæ¥å£å…¶å®åªéœ€æ¥æ”¶æ¥å£ Ã¬d å³å¯ã€‚æ¯”å¦‚ï¼Œæˆ‘æƒ³è¦å‘å¸ƒ id å”¯ä¸€çš„æ¥å£ï¼Œåªéœ€ä¼ é€’è¿™ä¸ªidä½œä¸ºå‚æ•°å³å¯ï¼Œè¿™æ ·å°±å¯ä»¥æ¸…æ¥šåœ°è¡¨ç¤ºè¦å¯¹å“ªä¸ªæ¥å£è¿›è¡Œå‘å¸ƒæ“ä½œã€‚

æ–°å»ºä¸€ä¸ªé€šç”¨çš„ IdRequestï¼šå°±æ˜¯å°è£…äº† id è¿™ä¸ªå‚æ•°ï¼Œå®ƒå°†ä¸€ä¸ªåŸºæœ¬ç±»å‹å°è£…æˆä¸€ä¸ªå¯¹è±¡ï¼Œè¿™æ ·ä¾¿äºæˆ‘ä»¬è¿›è¡Œjson å‚æ•°ä¼ é€’

```java
@Data
public class IdRequest implements Serializable {
    /**
     * id
     */
    private Long id;

    private static final long serialVersionUID = 1L;
}
```

- `InterfaceInfoController`ä¸­å‘å¸ƒæ¥å£æ–¹æ³• ä¸»è¦ä¹Ÿå°±åˆ†ä¸‰éƒ¨åˆ†
    - åˆ¤ç©ºåˆ¤æ–­æ˜¯å¦å­˜åœ¨æ¥å£
    - åˆ¤æ–­æ¥å£æ˜¯å¦æœ‰æ•ˆ èƒ½å¦è°ƒç”¨æˆåŠŸ
    - æ›´æ–°æ¥å£çŠ¶æ€
        - æ¥å£çŠ¶æ€ç”¨0 1 è¡¨ç¤º è¿™ç§å¸¸æ•°å€¼å†™ä¸€ä¸ª`enum`ç±»è¡¨ç¤º

```java
    /**
     * å‘å¸ƒæ¥å£
     *
     * @param idRequest
     * @return
     */
    @PostMapping("/online")
    @AuthCheck(mustRole = "admin")
    public BaseResponse<Boolean> onlineInterfaceInfo(@RequestBody IdRequest idRequest) {

        if(idRequest == null || idRequest.getId() <= 0 ){
            throw new BusinessException(ErrorCode.PARAMS_ERROR);
        }
        // åˆ¤æ–­æ˜¯å¦å­˜åœ¨
        long id = idRequest.getId();
        InterfaceInfo oldInterfaceInfo = interfaceInfoService.getById(id);
        if (oldInterfaceInfo == null) {
            throw new BusinessException(ErrorCode.NOT_FOUND_ERROR);
        }
        // åˆ¤æ–­èƒ½å¦è°ƒç”¨æˆåŠŸ
        com.qianapi.qianapiclientsdk.model.User user = new com.qianapi.qianapiclientsdk.model.User();
        user.setUsername("wangyixuan");
        System.out.println(qianapiClient);
        String userName = qianapiClient.getUserName(user);
        if (StringUtils.isBlank(userName)){
            throw new BusinessException(ErrorCode.SYSTEM_ERROR,"æ¥å£éªŒè¯å¤±è´¥");
        }

        // ä¿®æ”¹æ¥å£çŠ¶æ€
        InterfaceInfo interfaceInfo = new InterfaceInfo();
        interfaceInfo.setId(id);
        interfaceInfo.setStatus(InterfaceInfoStatusEnum.ONLINE.getValue());
        boolean result = interfaceInfoService.updateById(interfaceInfo);
        return ResultUtils.success(result);
    }
```

### ç®¡ç†å‘˜æƒé™

è¿™ä¸¤ä¸ªæ¥å£åªæœ‰ç®¡ç†å‘˜èƒ½è°ƒç”¨ï¼Œç»™æ¥å£æ‰“ä¸Šæ³¨è§£ï¼š`@AuthCheck(mustRole = "admin")`

## ç”¨æˆ·ç”³è¯·ç­¾å

- Userç±»æ·»åŠ ç­¾åak skå­—æ®µ
- UserMapperæ–‡ä»¶æ·»åŠ ç­¾åå­—æ®µ
- UserServiceImpl æ·»åŠ ç­¾å é€»è¾‘

### æ·»åŠ çœŸå®æ¥å£ä¸è¡¥å……å‚æ•°

- æ·»åŠ ä¸€ä¸ª`getUserName`(qianapi-interfaceä¸­)çš„æ¥å£
- æ–°å¢`requestParams`å‚æ•°
    - åœ¨å®ä½“ç±»ã€requestç±»ã€mapperä¸­æ–°å¢
    
    åœ¨çº¿è°ƒç”¨ä¸­æœ‰ä¸€ä¸ªå…³é”®ç‚¹ï¼Œé‚£å°±æ˜¯ç¡®å®šè¯·æ±‚å‚æ•°çš„ç±»å‹ã€‚é€šå¸¸ç”¨JSON æ¥ä½œä¸ºè¯·æ±‚å‚æ•°çš„ç±»å‹
    
    ```json
    [
        {"name": "username", "type": "string"}
        {è¯·æ±‚å‚æ•°åç§°, è¯·æ±‚å‚æ•°ç±»å‹}
    ]
    ```
    

## åœ¨çº¿è°ƒç”¨æ¥å£å¼€å‘

```mermaid
flowchart LR
    A[å‰ç«¯] -->|aaa.com/api| B[æ¥å£å¹³å°åç«¯]
    B -->|bbbb.com/api| C[æ¨¡æ‹Ÿæ¥å£]
```

å‰ç«¯ä¸ç›´æ¥è®¿é—®æ¨¡æ‹Ÿæ¥å£ï¼Œè¿™æ ·æ¨¡æ‹Ÿæ¥å£çš„åœ°å€ä¸ç”¨æš´éœ²ç»™å‰ç«¯æ›´åŠ å®‰å…¨æ–¹ä¾¿ã€‚

å‰ç«¯åœ¨è°ƒç”¨æ¥å£æ—¶ï¼Œé¦–å…ˆå°†è¦è°ƒç”¨çš„æ¥å£ä»¥åŠè¯·æ±‚å‚æ•°ä¼ é€’ç»™åç«¯ï¼Œç„¶ååç«¯ä½œä¸ºä¸­è½¬è§’è‰²ï¼Œå†å‘æ¨¡æ‹Ÿæ¥å£å‘é€è¯·æ±‚ã€‚é™¤äº†ä¸­è½¬åŠŸèƒ½ï¼Œåç«¯å¯èƒ½è¿˜éœ€è¦è¿›è¡Œä¸€äº›åˆ¤æ–­ï¼Œä¾‹å¦‚åˆ¤æ–­å‰ç«¯çš„æµ‹è¯•é¢‘ç‡æ˜¯å¦è¿‡é«˜ï¼Œæˆ–è€…åˆ¤æ–­å‰ç«¯æ˜¯å¦æœ‰æƒé™è¿›è¡Œè¯¥æ¥å£çš„æµ‹è¯•ã€‚

å‰ç«¯è¦åšçš„äº‹æƒ…ï¼Œå°±æ˜¯æŠŠæ‰€æœ‰å®ƒè¦è°ƒç”¨çš„æ¥å£ idã€è¯·æ±‚å‚æ•°ä¼ ç»™åç«¯ï¼Œåç«¯è´Ÿè´£è°ƒç”¨ã€‚

### å¼€å‘æµ‹è¯•è°ƒç”¨æ¥å£

```java
/**
 * æµ‹è¯•è°ƒç”¨
 *
 * @param interfaceInfoInvokeRequest 
 * @param request
 * @return
 */
@PostMapping("/invoke")
// è¿™é‡Œç»™å®ƒæ–°å°è£…ä¸€ä¸ªå‚æ•°InterfaceInfoInvokeRequest
// è¿”å›ç»“æœæŠŠå¯¹è±¡å‘å‡ºå»å°±å¥½äº†ï¼Œå› ä¸ºä¸ç¡®å®šæ¥å£çš„è¿”å›å€¼åˆ°åº•æ˜¯ä»€ä¹ˆ
public BaseResponse<String> invokeInterfaceInfo(@RequestBody InterfaceInfoInvokeRequest interfaceInfoInvokeRequest,
                                                HttpServletRequest request) {
    // æ£€æŸ¥è¯·æ±‚å¯¹è±¡æ˜¯å¦ä¸ºç©ºæˆ–è€…æ¥å£idæ˜¯å¦å°äºç­‰äº0
    if (interfaceInfoInvokeRequest == null || interfaceInfoInvokeRequest.getId() <= 0) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR);
    }
    // è·å–æ¥å£id
    long id = interfaceInfoInvokeRequest.getId();
    // åˆ¤æ–­æ˜¯å¦å­˜åœ¨
    InterfaceInfo oldInterfaceInfo = interfaceInfoService.getById(id);
    if (oldInterfaceInfo == null) {
        throw new BusinessException(ErrorCode.NOT_FOUND_ERROR);
    }
    // æ£€æŸ¥æ¥å£çŠ¶æ€æ˜¯å¦ä¸ºä¸‹çº¿çŠ¶æ€
    if (oldInterfaceInfo.getStatus() == InterfaceInfoStatusEnum.OFFLINE.getValue()) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "æ¥å£å·²å…³é—­");
    }
    
}

```

åœ¨ç”¨æˆ·è¿›è¡Œæµ‹è¯•è°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å‘ŠçŸ¥åç«¯ç”¨æˆ·çš„ç­¾åä¿¡æ¯ï¼Œè¿™æ ·æˆ‘ä»¬æ‰èƒ½åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å…·æœ‰è°ƒç”¨æ¥å£çš„æƒé™ã€‚æœ‰ä¸‰ç§æ–¹å¼ï¼š

1. è¦æ±‚ç”¨æˆ·å¿…é¡»å…·æœ‰æ¥å£æƒé™æ‰èƒ½è¿›è¡Œè°ƒç”¨ã€‚
2. å³ä½¿ç”¨æˆ·æ²¡æœ‰æƒé™ï¼Œä¹Ÿå…è®¸å…¶è¿›è¡Œè°ƒç”¨ï¼Œä»¥ä¾¿ä½“éªŒæ¥å£åŠŸèƒ½ã€‚å¦‚æœé€‰æ‹©è¿›è¡Œä½“éªŒï¼Œå»ºè®®ä¸ºç”¨æˆ·åˆ†é…ä¸´æ—¶çš„ç­¾åï¼Œç±»ä¼¼äºæµ‹è¯•ç¯å¢ƒï¼Œç»™äºˆä¸€å®šæ•°é‡çš„è°ƒç”¨æ¬¡æ•°ã€‚è¿™å¯èƒ½éœ€è¦æ–°å¢ä¸¤ä¸ªå­—æ®µï¼Œä¾‹å¦‚åœ¨æ•°æ®åº“ä¸­æ·»åŠ ä¸€ä¸ªæµ‹è¯•æ¬¡æ•°å­—æ®µï¼Œç¨å¾®å¤æ‚ä¸€äº›ã€‚
3. å¯ä»¥ç›´æ¥ä¸ºæ¯ä¸ªç”¨æˆ·æä¾›å‡ åæ¬¡è°ƒç”¨æœºä¼š

é‚£æˆ‘ä»¬è¿™é‡Œçš„è¯å°±ç›´æ¥ç”¨ä»–è‡ªå·±çš„è´¦å·äº†ã€‚

- è¿˜æ˜¯åœ¨ä¸Šé¢çš„`invokeInterfaceInfo` å‡½æ•°ä¸­

```java
// è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„akå’Œskï¼Œè¿™æ ·ç›¸å½“äºç”¨æˆ·è‡ªå·±çš„è¿™ä¸ªèº«ä»½å»è°ƒç”¨ï¼Œ
// ä¹Ÿä¸ä¼šæ‹…å¿ƒå®ƒåˆ·æ¥å£ï¼Œå› ä¸ºçŸ¥é“æ˜¯è°åˆ·äº†è¿™ä¸ªæ¥å£ï¼Œä¼šæ¯”è¾ƒå®‰å…¨
String requestParams = interfaceInfoInvokeRequest.getRequestParams();
User loginUser = userService.getLoginUser(request);
String accessKey = loginUser.getAccessKey();
String secretKey = loginUser.getSecretKey();
// æˆ‘ä»¬åªéœ€è¦è¿›è¡Œæµ‹è¯•è°ƒç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è§£æä¼ é€’è¿‡æ¥çš„å‚æ•°ã€‚
Gson gson = new Gson();
// å°†ç”¨æˆ·è¯·æ±‚å‚æ•°è½¬æ¢ä¸ºcom.qianapi.qianapiclientsdk.model.User userå¯¹è±¡
com.qianapi.qianapiclientsdk.model.User user = gson.fromJson(requestParams, 
                                                            com.qianapi.qianapiclientsdk.model.User.class);
// åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„QianapiClientå¯¹è±¡ ä¼ å…¥ak sk 
//å¦‚æœé‡‡ç”¨å…¨å±€çš„qianapiClientä¼šä½¿ç”¨applicationä¸­é…ç½®çš„ç®¡ç†å‘˜çš„ak sk
QianapiClient qianapiClient = new QianapiClient(accessKey, secretKey);
// è°ƒç”¨qianapiClientçš„getUserNameæ–¹æ³•
String userName = qianapiClient.getUserName(user);
return ResultUtils.success(userName);
```

ç›¸å½“äºå‰ç«¯è¯·æ±‚åç«¯é¡¹ç›®`qianapi-backend`ä¸­çš„`invokeInterfaceInfo` æ–¹æ³•ï¼Œå°†æ¥å£idä¸è¯·æ±‚å‚æ•°å°è£…ï¼ˆåç«¯æ¥æ”¶æ˜¯ä¸€ä¸ª`InterfaceInfoInvokeRequest`å¯¹è±¡ï¼‰ä»¥åŠ`HttpServletRequest` ï¼ˆç”¨äºè·å–å½“å‰ç™»å½•ç”¨æˆ·ï¼‰ï¼Œç„¶åé€šè¿‡`QianapiClient`è°ƒç”¨æ¥å£ã€‚

### æ¥å£è°ƒç”¨ç»Ÿè®¡

**éœ€æ±‚:**

1. ç”¨æˆ·æ¯æ¬¡è°ƒç”¨æ¥å£æˆåŠŸï¼Œæ¬¡æ•°+1
2. ç»™ç”¨æˆ·åˆ†é…æˆ–è€…ç”¨æˆ·è‡ªä¸»ç”³è¯·æ¥å£è°ƒç”¨æ¬¡æ•°

**ä¸šåŠ¡æµç¨‹:**

1. ç”¨æˆ·è°ƒç”¨æ¥å£(ä¹‹å‰å·²å®Œæˆ)
2. ä¿®æ”¹æ•°æ®åº“ï¼Œè°ƒç”¨æ¬¡æ•° +1

æ—¢ç„¶æ¯æ¬¡è°ƒç”¨æ¥å£æˆåŠŸéƒ½è¦åŠ 1æ¬¡æ•°ï¼Œé‚£ä¹ˆéœ€è¦åŒºåˆ†æ˜¯å“ªä¸ªç”¨æˆ·è°ƒç”¨äº†å“ªä¸ªæ¥å£ï¼Œè¿™æ„å‘³ç€ç”¨æˆ·å’Œæ¥å£ä¹‹é—´æ˜¯ä¸€ä¸ªå¤šå¯¹å¤šçš„å…³ç³»ï¼Œè®¾è®¡ä¸€ä¸ª"ç”¨æˆ·è°ƒç”¨æ¥å£å…³ç³»è¡¨â€æ¥å­˜å‚¨ç”¨æˆ·å’Œæ¥å£ä¹‹é—´çš„å…³ç³»ã€‚

ä¸»è¦æœ‰ä»¥ä¸‹å±æ€§

| ç”¨æˆ·id | è°ƒç”¨æ¥å£id | æ€»è°ƒç”¨æ¬¡æ•° | å‰©ä½™æ¬¡æ•° | çŠ¶æ€ |
| --- | --- | --- | --- | --- |

**æ­¥éª¤ï¼š**

ç¬¬ä¸€ç§æƒ…å†µæ˜¯ç”¨æˆ·æ²¡æœ‰è¿™ä¸ªè°ƒç”¨æ¬¡æ•°è®°å½•ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€æ¡æ–°çš„è®°å½•ã€‚

ç¬¬äºŒç§æƒ…å†µæ˜¯ç”¨æˆ·å·²ç»æœ‰äº†è°ƒç”¨æ¬¡æ•°è®°å½•ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç°æœ‰çš„æ¬¡æ•°åŸºç¡€ä¸ŠåŠ  1ã€‚

**å®ç°ï¼š**

é’ˆå¯¹æ–°çš„æ•°æ®è¡¨ é€šè¿‡mybatis-plusåˆ›å»ºæ–°çš„modelï¼šå®ä½“ç±»ã€dtoï¼Œæ–°çš„ä¸šåŠ¡é€»è¾‘ï¼šcontrollerã€serviceã€serviceImplã€mapperã€mapper.xmlç­‰

åœ¨serviceImplä¸­å®ç°è°ƒç”¨æ¬¡æ•°+1åŠŸèƒ½ï¼Œåœ¨controllerä¸­åªè¦è°ƒç”¨è¿™ä¸ªæ–¹æ³•å°±å¯ä»¥å®ç°è°ƒç”¨æ¬¡æ•°+1

```java
@Override
    public boolean invokeCount(long userId, long interfaceInfoId){
        if (userId <= 0 || interfaceInfoId <= 0) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "æ¥å£æˆ–ç”¨æˆ·ä¸å­˜åœ¨");
        }
        UpdateWrapper<UserInterfaceInfo> updateWrapper = new UpdateWrapper<>();
        updateWrapper.eq("userId", userId);
        updateWrapper.eq("interfaceInfoId", interfaceInfoId);
        // ä¿è¯å‰©ä½™æ¬¡æ•°å¤§äº0
        updateWrapper.gt("leftNum", 0);
        updateWrapper.setSql("leftNum = leftNum - 1, totalNum = totalNum + 1");
        boolean result = this.update(updateWrapper);

        return result;
    }
```

![image.png](/note_img/image%2010.png)

# APIç½‘å…³

æˆ‘ä»¬ç›®å‰çš„é¡¹ç›®æœ‰APIæ¥å£å¹³å°ã€åç«¯è°ƒç”¨é¡¹ç›®æ˜¯ä¸€ä¸ªå¤šé¡¹ç›®æ¶æ„

![image.png](/note_img/image%2011.png)

å‡è®¾ä¸€ä¸ªæ™®é€šç”¨æˆ·æƒ³è°ƒç”¨æ¥å£ Aã€‚æ“ä½œ:å…ˆè°ƒç”¨æ¥å£ Aï¼Œç„¶åæ¥å£Aå†è°ƒç”¨ç»Ÿè®¡æ¬¡æ•°æ–¹æ³•ï¼Œæ¥ç€è°ƒç”¨æ¥å£ Bï¼Œå†å»è°ƒç”¨ç»Ÿè®¡æ¬¡æ•°æ–¹æ³•ã€‚

![image.png](/note_img/image%2012.png)

ç°åœ¨ç”¨æˆ·ç›´æ¥è°ƒç”¨ç½‘å…³ï¼Œç”±ç½‘å…³è´Ÿè´£æ ¹æ®ç”¨æˆ·è¯·æ±‚çš„åœ°å€ï¼Œæ‰¾åˆ°å¯¹åº”çš„æ¥å£ï¼Œæ¯”å¦‚æ¥å£ Aï¼Œç„¶åè°ƒç”¨æ¥å£ Aï¼Œå¹¶åœ¨è°ƒç”¨åç»Ÿè®¡æ¬¡æ•°åŠ  1ã€‚åŒæ ·ï¼Œç”¨æˆ·è°ƒç”¨æ¥å£ Bæˆ–æ¥å£Cï¼Œä¹Ÿæ˜¯å…ˆè°ƒç”¨ç½‘å…³ï¼Œç„¶åç½‘å…³å†å»æ‰¾ç›¸åº”çš„æ¥å£å¹¶è¿›è¡Œè°ƒç”¨

é€šè¿‡è¿™ç§è®¾è®¡ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªç»Ÿä¸€çš„ç½‘å…³æ¥å¤„ç†ä¸åŒé¡¹ç›®çš„è¯·æ±‚ï¼Œç”¨æˆ·å’Œå¼€å‘è€…éƒ½ä¸éœ€è¦å…³å¿ƒå…·ä½“çš„ç»†èŠ‚ï¼Œç®€åŒ–äº†æ“ä½œï¼Œæé«˜äº†ç³»ç»Ÿçš„å¯ç”¨æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

### åœºæ™¯

1. **è·¯ç”±**
    
    èµ·åˆ°è½¬å‘çš„ä½œç”¨ï¼Œæ¯”å¦‚æœ‰æ¥å£ Aå’Œæ¥å£ Bï¼Œç½‘å…³ä¼šè®°å½•è¿™äº›ä¿¡æ¯ï¼Œæ ¹æ®ç”¨æˆ·è®¿é—®çš„åœ°å€å’Œå‚æ•°ï¼Œè½¬å‘è¯·æ±‚åˆ°å¯¹åº”çš„æ¥å£(æœåŠ¡å™¨/é›†ç¾¤)ã€‚
    /a =>æ¥å£A
    /b =>æ¥å£B
    
2. **è´Ÿè½½å‡è¡¡**
    
    åœ¨è·¯ç”±çš„åŸºç¡€ä¸Šã€‚
    
    /c => æœåŠ¡ A / é›†ç¾¤ Aï¼ˆéšæœºè½¬å‘åˆ°å…¶ä¸­çš„æŸä¸€ä¸ªæœºå™¨ï¼‰
    
3. **ç»Ÿä¸€é‰´æƒ**
    
    åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è¿›è¡Œæ“ä½œï¼Œæ— è®ºè®¿é—®ä»€ä¹ˆæ¥å£ï¼Œéƒ½ç»Ÿä¸€å»åˆ¤æ–­æƒé™ï¼Œä¸ç”¨é‡å¤å†™ã€‚
    
4. **ç»Ÿä¸€å¤„ç†è·¨åŸŸ**
    
    ç½‘å…³ç»Ÿä¸€å¤„ç†è·¨åŸŸï¼Œä¸ç”¨åœ¨æ¯ä¸ªé¡¹ç›®é‡Œå•ç‹¬å¤„ç†ã€‚
    
5. **ç»Ÿä¸€ä¸šåŠ¡å¤„ç†(ç¼“å­˜)**
    
    æŠŠä¸€äº›æ¯ä¸ªé¡¹ç›®ä¸­éƒ½è¦åšçš„é€šç”¨é€»è¾‘æ”¾åˆ°ä¸Šå±‚ï¼ˆç½‘å…³ï¼‰ï¼Œç»Ÿä¸€å¤„ç†ï¼Œæ¯”å¦‚æœ¬é¡¹ç›®çš„æ¬¡æ•°ç»Ÿè®¡ã€‚
    
6. **è®¿é—®æ§åˆ¶**
    
    é»‘ç™½åå•ï¼Œæ¯”å¦‚é™åˆ¶ DDOS IPã€‚
    
7. **å‘å¸ƒæ§åˆ¶**
    
    ç°åº¦å‘å¸ƒï¼Œæ¯”å¦‚ä¸Šçº¿æ–°æ¥å£ï¼Œå…ˆç»™æ–°æ¥å£åˆ†é… 20% çš„æµé‡ï¼Œè€æ¥å£ 80%ï¼Œå†æ…¢æ…¢è°ƒæ•´æ¯”é‡ã€‚
    
    https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-weight-route-predicate-factory
    
8. **æµé‡æŸ“è‰²ï¼ˆè®°å½•è¯·æ±‚æ˜¯å¦æ˜¯ç½‘å…³æ¥çš„ï¼‰**
    
    ç»™è¯·æ±‚ï¼ˆæµé‡ï¼‰æ·»åŠ ä¸€äº›æ ‡è¯†ï¼Œä¸€èˆ¬æ˜¯è®¾ç½®è¯·æ±‚å¤´ä¸­ï¼Œæ·»åŠ æ–°çš„è¯·æ±‚å¤´ã€‚
    
    1. å…¨å±€æŸ“è‰² [Spring Cloud Gateway](https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#default-filters)
9. **æ¥å£ä¿æŠ¤**
    1. é™åˆ¶è¯·æ±‚
    2. ä¿¡æ¯è„±æ•â€”â€”[the-removerequestheader-gatewayfilter-factory](https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-removerequestheader-gatewayfilter-factory)
    3. é™çº§(ç†”æ–­)â€”â€”[fallback-headers](https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#fallback-headers)
    4. é™æµâ€”â€” [the-requestratelimiter-gatewayfilter-factory](https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-requestratelimiter-gatewayfilter-factory) å­¦ä¹ ä»¤ç‰Œæ¡¶ç®—æ³•ã€å­¦ä¹ æ¼æ¡¶ç®—æ³•ï¼Œå­¦ä¹ ä¸€ä¸‹ RedisLimitHandler
    5. è¶…æ—¶æ—¶é—´â€”â€”[http-timeouts-configuration](https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#http-timeouts-configuration)
10. **ç»Ÿä¸€æ—¥å¿—**
    
    ç»Ÿä¸€çš„è¯·æ±‚ã€å“åº”ä¿¡æ¯è®°å½•ã€‚
    
11. **ç»Ÿä¸€æ–‡æ¡£**
    
    å°†ä¸‹æ¸¸é¡¹ç›®çš„æ–‡æ¡£è¿›è¡Œèšåˆï¼Œåœ¨ä¸€ä¸ªé¡µé¢ç»Ÿä¸€æŸ¥çœ‹ã€‚
    

### ç½‘å…³åˆ†ç±»

1. å…¨å±€ç½‘å…³ï¼ˆæ¥å…¥å±‚ç½‘å…³ï¼‰ï¼šæ›´å¤šçš„æ˜¯é’ˆå¯¹è¯·æ±‚ï¼Œä½œç”¨æ˜¯è´Ÿè½½å‡è¡¡ã€è¯·æ±‚æ—¥å¿—ç­‰ï¼Œä¸å’Œä¸šåŠ¡é€»è¾‘ç»‘å®šã€‚
    
    å…¨å±€ç½‘å…³çš„ä¸»è¦åŠŸèƒ½æ˜¯è´Ÿè½½å‡è¡¡ï¼Œå°†å¤§é‡çš„è¯·æ±‚å¹³å‡åˆ†æ‘Šåˆ°ç³»ç»Ÿä¸­çš„å¤šå°æœºå™¨ä¸Šã€‚å®ƒé€šå¸¸ä¸æ¶‰åŠè¿‡å¤šçš„ä¸šåŠ¡é€»è¾‘ï¼Œè€Œæ›´æ³¨é‡å¤„ç†è¯·æ±‚æ—¥å¿—ç­‰ä»»åŠ¡ã€‚
    
2. ä¸šåŠ¡ç½‘å…³ï¼ˆå¾®æœåŠ¡ç½‘å…³ï¼‰ï¼šä¼šæœ‰ä¸€äº›ä¸šåŠ¡é€»è¾‘ï¼Œä½œç”¨æ˜¯å°†è¯·æ±‚è½¬å‘åˆ°ä¸åŒçš„ä¸šåŠ¡ / é¡¹ç›® / æ¥å£ / æœåŠ¡ã€‚
    
    ä¸šåŠ¡ç½‘å…³åˆ™æ›´å¤šåœ°å…³æ³¨ä¸šåŠ¡é€»è¾‘ï¼Œä¾‹å¦‚ç»Ÿè®¡æ¬¡æ•°ã€è¯·æ±‚é‰´æƒç­‰ï¼ŒåŒæ—¶ä¹Ÿä¼šè´Ÿè´£è½¬å‘è¯·æ±‚åˆ°å…·ä½“çš„ä¸šåŠ¡å¤„ç†å•å…ƒã€‚
    

[å¾®æœåŠ¡ç½‘å…³é€‰å‹ï¼š5ç§ä¸»æµ API ç½‘å…³](https://zhuanlan.zhihu.com/p/500587132)

**ä¾‹å­ï¼š**

Nginxï¼ˆå…¨å±€ç½‘å…³ï¼‰ã€Kong ç½‘å…³ï¼ˆAPI ç½‘å…³ï¼Œ[**Kong**](https://github.com/Kong/kong)ï¼‰ï¼Œç¼–ç¨‹æˆæœ¬ç›¸å¯¹é«˜ä¸€ç‚¹ã€‚

Spring Cloud Gatewayï¼ˆå–ä»£äº† Zuulï¼‰æ€§èƒ½é«˜ã€å¯ä»¥ç”¨ Java ä»£ç æ¥å†™é€»è¾‘ï¼Œé€‚äºå­¦ä¹ ã€‚

[Kong API ç½‘å…³è¯¦è§£ä¸å®è·µ](https://blog.csdn.net/qq_21040559/article/details/122961395)

## Spring cloud gateway

å‡è®¾ä½ åšäº†ä¸€ä¸ªç”µå•†ç³»ç»Ÿï¼Œæœ‰ä¸‰ä¸ªå¾®æœåŠ¡ï¼š

```java
localhost:9001/user       -> å¤„ç†ç”¨æˆ·ç›¸å…³æ¥å£
localhost:9002/product    -> å¤„ç†å•†å“ç›¸å…³æ¥å£
localhost:9003/order      -> å¤„ç†è®¢å•ç›¸å…³æ¥å£
```

ä½ æƒ³è®©ç”¨æˆ·é€šè¿‡ä¸€ä¸ªç»Ÿä¸€çš„å…¥å£è®¿é—®ï¼Œæ¯”å¦‚ï¼š

```java
localhost:8080/user/**     => è½¬å‘åˆ° localhost:9001/user/**
localhost:8080/product/**  => è½¬å‘åˆ° localhost:9002/product/**
localhost:8080/order/**    => è½¬å‘åˆ° localhost:9003/order/**
```

ä½ åªè¦ç”¨ Spring Cloud Gateway é…ä¸€ä¸ªè§„åˆ™ï¼Œå°±å¯ä»¥å®ç°è¿™äº›åŠŸèƒ½äº†ã€‚

```yaml
# application.yml
server:
  port: 8080

spring:
  cloud:
    gateway:
      routes:
        - id: user-service
          uri: http://localhost:9001
          predicates:
            - Path=/user/**
        - id: product-service
          uri: http://localhost:9002
          predicates:
            - Path=/product/**
        - id: order-service
          uri: http://localhost:9003
          predicates:
            - Path=/order/**
```

è¿™ä¸ªé…ç½®çš„æ„æ€æ˜¯ï¼š

- å½“ç”¨æˆ·è®¿é—® `/user/**` å¼€å¤´çš„è·¯å¾„æ—¶ï¼ŒGateway è‡ªåŠ¨è½¬å‘åˆ° `localhost:9001`
- `/product/**` è½¬åˆ° `localhost:9002`
- `/order/**` è½¬åˆ° `localhost:9003`

**ç»„æˆï¼š**

- **è·¯ç”±ï¼š**æ ¹æ®ä»€ä¹ˆæ¡ä»¶ï¼Œè½¬å‘è¯·æ±‚åˆ°å“ªé‡Œ
    - `.route`
- **æ–­è¨€ï¼š**ä¸€ç»„è§„åˆ™ã€æ¡ä»¶ï¼Œç”¨æ¥ç¡®å®šå¦‚ä½•è½¬å‘è·¯ç”±
    - `r -> r.path("/path")`
    - `predicates:
      - Path=/user/**`
- **è¿‡æ»¤å™¨ï¼š**å¯¹è¯·æ±‚è¿›è¡Œä¸€ç³»åˆ—çš„å¤„ç†ï¼Œæ¯”å¦‚æ·»åŠ è¯·æ±‚å¤´ã€æ·»åŠ è¯·æ±‚å‚æ•°

```java
@SpringBootApplication
public class DemogatewayApplication {
    @Bean
    public RouteLocator customRouteLocator(RouteLocatorBuilder builder) {
        return builder.routes()
                .route("path_route", r -> r.path("/path")
                        .uri("http://httpbin.org"))
                .route("host_route", r -> r.host("*.myhost.org")
                        .uri("http://httpbin.org"))
                .build();
    }
}
```

![image.png](/note_img/image%2013.png)

**è¯·æ±‚æµç¨‹**

1. Gateway Clientå®¢æˆ·ç«¯å‘èµ·è¯·æ±‚
2. Handler Mappingï¼šæ ¹æ®æ–­è¨€ï¼Œå»å°†è¯·æ±‚è½¬å‘åˆ°å¯¹åº”çš„è·¯ç”±
3. Web Handlerï¼šå¤„ç†è¯·æ±‚ï¼ˆä¸€å±‚å±‚ç»è¿‡è¿‡æ»¤å™¨ï¼‰
4. å®é™…è°ƒç”¨æœåŠ¡

### ä¸¤ç§é…ç½®æ–¹å¼

1. é…ç½®å¼
2. ç¼–ç¨‹å¼

### Handler Mapping

Path Routeï¼šå¦‚æœä½ è®¿é—®çš„åœ°å€æ˜¯ä»¥å¯¹åº”è·¯å¾„ä½œä¸ºå‰ç¼€çš„ï¼Œé‚£ä¹ˆå°±ç»™ä½ è®¿é—®åˆ°å¯¹åº”çš„åœ°å€ã€‚

XForwarded Remote Addr Routeï¼Œè¿™ä¸ªåŠŸèƒ½å…è®¸æˆ‘ä»¬ä»è¯·æ±‚å¤´ä¸­è·å– X-Forwarded-Remote-Addr è¿™ä¸ªå­—æ®µï¼Œå¦‚æœå®ƒçš„å€¼æ˜¯ 192.168.1.1/24ï¼Œé‚£ä¹ˆå°±ä¼šå°†è¯·æ±‚é‡å®šå‘åˆ°åœ°å€Â [https://example.orgã€‚](https://example.org./)

Query Routeï¼Œé€šè¿‡å®ƒå¯ä»¥æ ¹æ®æŸ¥è¯¢æ¡ä»¶è¿›è¡Œè·¯ç”±åŒ¹é…ï¼Œæ¯”å¦‚è¯´ä½ çš„è¯·æ±‚å‚æ•°ä¸­åŒ…å«ä¸€ä¸ªåä¸º "green" çš„æŸ¥è¯¢å‚æ•°ï¼Œé‚£å®ƒå°±ä¼šåŒ¹é…åˆ°è¿™ä¸ªåœ°å€ã€‚

Remoteaddr Routeï¼Œå®ƒå…è®¸æˆ‘ä»¬æ ¹æ®è¿œç¨‹åœ°å€æ¥è¿›è¡Œè·¯ç”±åŒ¹é…ã€‚æ¯”å¦‚è®¿é—®ç”¨æˆ·çš„ IP åœ°å€æ˜¯ 192.168.1.1/24ï¼Œå°±é‡å®šå‘åˆ°æŒ‡å®šçš„åœ°å€Â [https://example.orgã€‚](https://example.org./)

- é…ç½®ä¸åŒçš„è·¯ç”± ä½†ä¸çŸ¥é“ä½¿ç”¨äº†å“ªæ¡è§„åˆ™ å¯ä»¥è®¾ç½®æ‰“å°æ—¥å¿—

```yaml
logging:
  level:
    org.springframework:
      cloud.gateway: trace
```

å°†springframeworkä¸­çš„gatewayæ—¥å¿—çº§åˆ«è®¾ç½®ä¸ºæœ€ä½

### Web Handlerï¼ˆè¿‡æ»¤å™¨ æ‹¦æˆªå™¨ï¼‰å¯¹è¯·æ±‚è¿›è¡Œä¸€äº›æ“ä½œ

- AddRequestHeader
    
    ```yaml
    spring:
      cloud:
        gateway:
          routes:
            - id: path_route
              uri: http://localhost:8123
              predicates:
                - Path=/api/name/**
              filters:
                - AddRequestHeader=myheader, hahaha
    ```
    
    å½“è®¿é—®[localhost:8090/api/name/gate](http://localhost:8090/api/name/gate)ä¼šé‡å®šå‘åˆ°[http://localhost:8123/api/name/gate](http://localhost:8123/api/name/gate)
    
    æ·»åŠ ä¸€ä¸ªè¯·æ±‚å¤´ myheader å€¼æ˜¯ hahaha åç«¯å¯ä»¥é€šè¿‡`request.getHeader("myheader")`
    
- AddRequestParameter
    
    æ·»åŠ è¯·æ±‚å‚æ•°
    
- DedupeResponseHeader
    
    è¯·æ±‚ç»è¿‡äº†å¤šä¸ªæœåŠ¡å™¨ï¼Œæ¯ä¸ªæœåŠ¡å™¨éƒ½æ·»åŠ äº†ä¸€å±‚è·¨åŸŸå¤´ã€‚ä½†æ˜¯ç”±äºé‡å¤æ·»åŠ è·¨åŸŸå¤´ï¼Œå¯èƒ½å¯¼è‡´æœ€ç»ˆè·¨åŸŸå¤±è´¥å¹¶å‡ºç°é”™è¯¯ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ DedupeResponseHeader æ¥å»é™¤é‡å¤çš„å“åº”å¤´ã€‚
    

## ç½‘å…³å¼€å‘

### ä¸šåŠ¡é€»è¾‘

1. ç”¨æˆ·å‘é€è¯·æ±‚åˆ°APIç½‘å…³
2. è¯·æ±‚æ—¥å¿—
3. é»‘ç™½åå•
4. APIç½‘å…³é‰´æƒï¼ˆak skï¼‰
5. åˆ¤æ–­æ¥å£æ˜¯å¦å­˜åœ¨
6. **è¯·æ±‚è½¬å‘ï¼Œè°ƒç”¨æ¨¡æ‹Ÿæ¥å£**
7. å“åº”æ—¥å¿—
8. è°ƒç”¨æˆåŠŸï¼Œæ¥å£è°ƒç”¨æ¬¡æ•°+1
9. è°ƒç”¨å¤±è´¥ï¼Œè¿”å›ä¸€ä¸ªè§„èŒƒçš„é”™è¯¯ç 

### è¯·æ±‚è½¬å‘

æ¥å£åœ°å€ä¸º [localhost:8123/api/name/get?name=wangyixuan](http://localhost:8123/api/name/get?name=wangyixuan)

å¯ä»¥ç”¨ä¸€ä¸ªå‰ç¼€è·¯ç”±å™¨ åŒ¹é…/apiè·¯å¾„ localhost:8123/api/**

æ¯”å¦‚è¯·æ±‚ç½‘å…³ï¼šlocalhost:8090/api/name/get?name=wyx

è½¬å‘åˆ°ï¼šlocalhost:8123/api/name/get?name=wyx

```yaml
server:
  port: 8090
spring:
  cloud:
    gateway:
      routes:
        - id: api_route
          uri: http://localhost:8123
          predicates:
            - Path=/api/**
```

- **å…¨å±€è¿‡æ»¤å™¨**
    
    å¯¹å…¨éƒ¨çš„è¯·æ±‚è¿›è¡Œç»Ÿä¸€å¤„ç†
    
    ```java
    @Slf4j
    @Component
    public class CustomGlobalFilter implements GlobalFilter, Ordered {
    
        @Override
        public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
            log.info("custom global filter");
            return chain.filter(exchange);
        }
    
        @Override
        public int getOrder() {
            return -1;
        }
    }
    ```
    
    `Ordered`è¡¨ç¤ºå¤šä¸ªè¿‡æ»¤å™¨çš„é¡ºåº
    
    ```java
        @Override
        public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
            // 1. è¯·æ±‚æ—¥å¿—
            ServerHttpRequest request = exchange.getRequest();
            log.info("è¯·æ±‚å”¯ä¸€æ ‡è¯†ï¼š" + request.getId());
            log.info("è¯·æ±‚è·¯å¾„ï¼š" + request.getPath().value());
            log.info("è¯·æ±‚æ–¹æ³•ï¼š" + request.getMethod());
            log.info("è¯·æ±‚å‚æ•°ï¼š" + request.getQueryParams());
            String sourceIp = request.getRemoteAddress().getHostString();
            log.info("è¯·æ±‚æ¥æºåœ°å€ï¼š" + request.getRemoteAddress());
            log.info("è¯·æ±‚æ¥æºåœ°å€ï¼š" + request.getLocalAddress().getHostString());
    
            ServerHttpResponse serverHttpResponse = exchange.getResponse();
            // 2. è®¿é—®æ§åˆ¶ - é»‘ç™½åå•
            if(!IP_WHITE_LIST.contains(sourceIp)){
                serverHttpResponse.setStatusCode(HttpStatus.FORBIDDEN);
                return serverHttpResponse.setComplete();
            }
            log.info("IPåœ¨ç™½åå•ä¸­ï¼Œæ”¾è¡Œ");
    
            // 3. APIç½‘å…³é‰´æƒï¼ˆak skï¼‰
            HttpHeaders headers = request.getHeaders();
            String access = headers.getFirst("accessKey");
            String body = headers.getFirst("body");
            String timestamp = headers.getFirst("timestamp");
            String nonce = headers.getFirst("nonce");
            String sign = headers.getFirst("sign");
    
            // TODO å®é™…æƒ…å†µæ˜¯å»æ•°æ®åº“ä¸­æŸ¥æ˜¯å¦å·²åˆ†é…ç»™ç”¨æˆ·
            if(!"access".equals(access)){
                return handleNoAuth(serverHttpResponse);
            }
            //è·å–çš„æ—¶é—´æˆ³ - å½“å‰æ—¶é—´æˆ³ å¦‚æœå¤§äº”åˆ†é’Ÿ è¡¨ç¤ºè¶…æ—¶
            final Long FIVE_MINIUTES = 5 * 60 * 1000L;
            if(Math.abs(Long.parseLong(timestamp) - System.currentTimeMillis()) > FIVE_MINIUTES){
                return handleNoAuth(serverHttpResponse);
            }
            if(Long.parseLong(nonce)>10000){
                return handleNoAuth(serverHttpResponse);
            }
            // TODO å®¢æˆ·ç«¯çš„ secretKey å°±æ˜¯æœåŠ¡ç«¯ç­¾å‘çš„ å®é™…åº”å½“å»æ•°æ®åº“ä¸­æŸ¥æ‰¾accessKeyå¯¹åº”çš„
            String serverSign = SignUtils.genSign(body, "asdfghjkl");
            if(!sign.equals(serverSign)){
                return handleNoAuth(serverHttpResponse);
            }
            // 4. åˆ¤æ–­è¯·æ±‚çš„æ¥å£æ˜¯å¦å­˜åœ¨
            // todo ä»æ•°æ®åº“æŸ¥è¯¢æ¨¡æ‹Ÿæ¥å£æ˜¯å¦å­˜åœ¨
    
            // 5. è¯·æ±‚è½¬å‘ï¼Œè°ƒç”¨æ¨¡æ‹Ÿæ¥å£
            Mono<Void> filter = chain.filter(exchange);
    
            // 6. å“åº”æ—¥å¿—
            return handleResponse(exchange, chain);
    
    //        // 7. è°ƒç”¨æˆåŠŸï¼Œæ¥å£è°ƒç”¨æ¬¡æ•°+1
    //        if(serverHttpResponse.getStatusCode() == HttpStatus.OK){
    //
    //        }
    //        // 8. è°ƒç”¨å¤±è´¥ï¼Œè¿”å›ä¸€ä¸ªè§„èŒƒçš„é”™è¯¯ç 
    //        else{
    //            serverHttpResponse.setStatusCode(HttpStatus.INTERNAL_SERVER_ERROR);
    //            return serverHttpResponse.setComplete();
    //        }
    //
    //        // è¿™é‡Œè¡¨ç¤ºæ­£å¸¸æ”¾è¡Œ
    //        return filter;
        }
    ```
    

### å¼‚æ­¥è°ƒç”¨

é¢„æœŸæ˜¯ç­‰æ¨¡æ‹Ÿæ¥å£è°ƒç”¨å®Œæˆï¼Œæ‰è®°å½•å“åº”æ—¥å¿—ã€ç»Ÿè®¡è°ƒç”¨æ¬¡æ•°ã€‚ä½†ç°å®æ˜¯ chain.filter æ–¹æ³•ç«‹åˆ»è¿”å›äº†ï¼Œç›´åˆ° filter è¿‡æ»¤å™¨ return åæ‰è°ƒç”¨äº†æ¨¡æ‹Ÿæ¥å£ã€‚åŸå› æ˜¯:chain.filter æ˜¯ä¸ªå¼‚æ­¥æ“ä½œï¼Œç†è§£ä¸ºå‰ç«¯çš„ promise

[å“åº”å¼ç¼–ç¨‹](https://www.notion.so/1f352b323dd180a68947c405f20367a3?pvs=21) 

## ç»Ÿè®¡åŠŸèƒ½å¼€å‘

ç»Ÿè®¡è°ƒç”¨æ•°é‡å‰ä¸‰çš„æ¥å£ä¿¡æ¯ï¼Œè¿”å›ç»™å‰ç«¯ã€‚

**åç«¯æµç¨‹ï¼š**

è·å–è°ƒç”¨æ¬¡æ•°æœ€å¤šçš„å‡ ä¸ªæ¥å£ï¼Œæ¥å£è°ƒç”¨æ•°é‡åœ¨`user_interface_info`è¡¨ä¸­ï¼Œé€šè¿‡sqlè¯­å¥æŸ¥è¯¢åˆ°`userInterfaceInfo`çš„Listï¼Œä½†æ˜¯listä¸­åªæœ‰æ¥å£çš„idï¼Œç„¶åå†åœ¨`inerface_info`è¡¨ä¸­æŸ¥åˆ°æ¥å£ä¿¡æ¯å½¢æˆlistè¿”å›ç»™å‰ç«¯

```sql
select interfaceInfoId, sum(totalNum) as totalNum
from user_interface_info
group by interfaceInfoId
order by totalNum desc
limit 3;
```

- æ‰€ä»¥è¿‡ç¨‹ä¸»è¦ä¸¤æ­¥ï¼Œé¦–å…ˆä»`user_interface_info`è¡¨è·å–è°ƒç”¨æ•°é‡æœ€å¤šçš„å‡ ä¸ªlistï¼Œå°†listæŒ‰ç…§æ¥å£idåˆ†ç»„ï¼Œä½¿ç”¨æ¥å£idä½œä¸ºé”®æ„é€ æŸ¥è¯¢å™¨æŸ¥è¯¢`inerface_info`è¡¨ï¼Œè¿™æ ·å°±æŸ¥åˆ°è°ƒç”¨æ•°é‡æœ€å¤šçš„å‡ ä¸ªæ¥å£ä¿¡æ¯ã€‚
    
    ```java
    /**
     * åˆ†ææ§åˆ¶å™¨
     */
    @RestController
    @RequestMapping("/analysis")
    @Slf4j
    public class AnalysisController {
    
        @Resource
        private UserInterfaceInfoMapper userInterfaceInfoMapper;
    
        @Resource
        private InterfaceInfoService interfaceInfoService;
        
        /**
         * è·å–è°ƒç”¨æ¬¡æ•°æœ€å¤šçš„æ¥å£ä¿¡æ¯åˆ—è¡¨ã€‚
         * é€šè¿‡ç”¨æˆ·æ¥å£ä¿¡æ¯è¡¨æŸ¥è¯¢è°ƒç”¨æ¬¡æ•°æœ€å¤šçš„æ¥å£IDï¼Œå†å…³è”æŸ¥è¯¢æ¥å£è¯¦ç»†ä¿¡æ¯ã€‚
         *
         * @return æ¥å£ä¿¡æ¯åˆ—è¡¨ï¼ŒåŒ…å«è°ƒç”¨æ¬¡æ•°æœ€å¤šçš„æ¥å£ä¿¡æ¯
         */
        @GetMapping("/top/interface/invoke")
        @AuthCheck(mustRole = "admin")
        public BaseResponse<List<InterfaceInfoVO>> listTopInvokeInterfaceInfo() {
            // æŸ¥è¯¢è°ƒç”¨æ¬¡æ•°æœ€å¤šçš„æ¥å£ä¿¡æ¯åˆ—è¡¨
            List<UserInterfaceInfo> userInterfaceInfoList = userInterfaceInfoMapper.listTopInvokeInterfaceInfo(3);
            // å°†æ¥å£ä¿¡æ¯æŒ‰ç…§æ¥å£IDåˆ†ç»„ï¼Œä¾¿äºå…³è”æŸ¥è¯¢
            Map<Long, List<UserInterfaceInfo>> interfaceInfoIdObjMap = userInterfaceInfoList.stream()
                    .collect(Collectors.groupingBy(UserInterfaceInfo::getInterfaceInfoId));
            // åˆ›å»ºæŸ¥è¯¢æ¥å£ä¿¡æ¯çš„æ¡ä»¶åŒ…è£…å™¨
            QueryWrapper<InterfaceInfo> queryWrapper = new QueryWrapper<>();
            // è®¾ç½®æŸ¥è¯¢æ¡ä»¶ï¼Œä½¿ç”¨æ¥å£ä¿¡æ¯IDåœ¨æ¥å£ä¿¡æ¯æ˜ å°„ä¸­çš„é”®é›†åˆè¿›è¡Œæ¡ä»¶åŒ¹é…
            queryWrapper.in("id", interfaceInfoIdObjMap.keySet());
            // è°ƒç”¨æ¥å£ä¿¡æ¯æœåŠ¡çš„listæ–¹æ³•ï¼Œä¼ å…¥æ¡ä»¶åŒ…è£…å™¨ï¼Œè·å–ç¬¦åˆæ¡ä»¶çš„æ¥å£ä¿¡æ¯åˆ—è¡¨
            List<InterfaceInfo> list = interfaceInfoService.list(queryWrapper);
            // åˆ¤æ–­æŸ¥è¯¢ç»“æœæ˜¯å¦ä¸ºç©º
            if (CollectionUtils.isEmpty(list)) {
                throw new BusinessException(ErrorCode.SYSTEM_ERROR);
            }
            // æ„å»ºæ¥å£ä¿¡æ¯VOåˆ—è¡¨ï¼Œä½¿ç”¨æµå¼å¤„ç†å°†æ¥å£ä¿¡æ¯æ˜ å°„ä¸ºæ¥å£ä¿¡æ¯VOå¯¹è±¡ï¼Œå¹¶åŠ å…¥åˆ—è¡¨ä¸­
            List<InterfaceInfoVO> interfaceInfoVOList = list.stream().map(interfaceInfo -> {
                // åˆ›å»ºä¸€ä¸ªæ–°çš„æ¥å£ä¿¡æ¯VOå¯¹è±¡
                InterfaceInfoVO interfaceInfoVO = new InterfaceInfoVO();
                // å°†æ¥å£ä¿¡æ¯å¤åˆ¶åˆ°æ¥å£ä¿¡æ¯VOå¯¹è±¡ä¸­
                BeanUtils.copyProperties(interfaceInfo, interfaceInfoVO);
                // ä»æ¥å£ä¿¡æ¯IDå¯¹åº”çš„æ˜ å°„ä¸­è·å–è°ƒç”¨æ¬¡æ•°
                int totalNum = interfaceInfoIdObjMap.get(interfaceInfo.getId()).get(0).getTotalNum();
                // å°†è°ƒç”¨æ¬¡æ•°è®¾ç½®åˆ°æ¥å£ä¿¡æ¯VOå¯¹è±¡ä¸­
                interfaceInfoVO.setTotalNum(totalNum);
                // è¿”å›æ„å»ºå¥½çš„æ¥å£ä¿¡æ¯VOå¯¹è±¡
                return interfaceInfoVO;
            }).collect(Collectors.toList());
            // è¿”å›å¤„ç†ç»“æœ
            return ResultUtils.success(interfaceInfoVOList);
        }
    }
    
    ```
    

# åˆ†å¸ƒå¼æ”¹é€ 

å¦‚ä½•è°ƒç”¨å…¶ä»–é¡¹ç›®çš„æ–¹æ³•ä¾‹å¦‚HTTPè¯·æ±‚ä¸RPC ä¸¤è€…çš„åŒºåˆ«æ˜¯é¢è¯•çƒ­ç‚¹

**HTTP è¯·æ±‚æ€ä¹ˆè°ƒç”¨ï¼Ÿ**

- æä¾›æ–¹å¼€å‘ä¸€ä¸ªæ¥å£ï¼ˆåœ°å€ã€è¯·æ±‚æ–¹æ³•ã€å‚æ•°ã€è¿”å›å€¼ï¼‰
- è°ƒç”¨æ–¹ä½¿ç”¨ HTTP Client ä¹‹ç±»çš„ä»£ç åŒ…å»å‘é€ HTTP è¯·æ±‚

**RPCï¼ˆRemote Procedure Callï¼‰**

- ä½œç”¨ï¼šåƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·è°ƒç”¨è¿œç¨‹æ–¹æ³•ã€‚

**å’Œç›´æ¥ HTTP è°ƒç”¨çš„åŒºåˆ«ï¼š**

1. å¯¹å¼€å‘è€…æ›´é€æ˜ï¼Œå‡å°‘äº†å¾ˆå¤šçš„æ²Ÿé€šæˆæœ¬ã€‚
2. RPC å‘è¿œç¨‹æœåŠ¡å™¨å‘é€è¯·æ±‚æ—¶ï¼Œæœªå¿…è¦ä½¿ç”¨ HTTP åè®®ï¼Œæ¯”å¦‚è¿˜å¯ä»¥ç”¨ TCP / IPï¼Œæ€§èƒ½æ›´é«˜ã€‚ï¼ˆå†…éƒ¨æœåŠ¡æ›´é€‚ç”¨ï¼‰ã€‚

## Dubbo

**ä¸¤ç§ä½¿ç”¨æ–¹å¼ï¼š**

1. Spring Boot ä»£ç ï¼ˆæ³¨è§£ + ç¼–ç¨‹å¼ï¼‰ï¼šå†™ Java æ¥å£ï¼ŒæœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…éƒ½å»å¼•ç”¨è¿™ä¸ªæ¥å£ã€‚
2. IDLï¼ˆæ¥å£è°ƒç”¨è¯­è¨€ï¼‰ï¼šåˆ›å»ºä¸€ä¸ªå…¬å…±çš„æ¥å£å®šä¹‰æ–‡ä»¶ï¼ŒæœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…è¯»å–è¿™ä¸ªæ–‡ä»¶ã€‚ä¼˜ç‚¹æ˜¯è·¨è¯­è¨€ï¼Œæ‰€æœ‰çš„æ¡†æ¶éƒ½è®¤è¯†ã€‚

Dubboåº•å±‚ç”¨çš„æ˜¯ Triple åè®®ï¼š

## Nacos

```bash
# Linux/Unix/Mac
sh startup.sh -m standalone

# ubuntu
bash startup.sh -m standalone

# Windows
startup.cmd -m standalone
```

## **æŠ½è±¡å…¬å…±æœåŠ¡**

- `qianapi-gateway`é¡¹ç›®ä¸­éœ€è¦ä½¿ç”¨ä¸€äº›å¦‚ä¸‹æ¶‰åŠæ•°æ®åº“æ“ä½œçš„åŠŸèƒ½ï¼Œä½†æ˜¯ä¸æ•°æ®åº“æ“ä½œåªåœ¨`qianapi-backend` é¡¹ç›®æ“ä½œï¼Œäºæ˜¯å¯ä»¥å°†ä¸€äº›åŠŸèƒ½æŠ½è±¡å‡ºæ¥ä½œä¸ºå…¬å…±`service`ï¼Œåœ¨`qianapi-backend` é¡¹ç›®å®ç°`serviceImpl` ï¼Œé€šè¿‡dubboæä¾›åŠŸèƒ½
    - *å®é™…æƒ…å†µæ˜¯å»æ•°æ®åº“ä¸­æŸ¥æ˜¯å¦å·²åˆ†é…ç»™ç”¨æˆ·*
    - *ä»æ•°æ®åº“æŸ¥è¯¢æ¨¡æ‹Ÿæ¥å£æ˜¯å¦å­˜åœ¨*
    - *è°ƒç”¨æˆåŠŸ æ¥å£è°ƒç”¨æ¬¡æ•°+1 invokecount*

**æ­¥éª¤ï¼š**

1. æ–°å»ºå¹²å‡€çš„ maven é¡¹ç›®ï¼Œåªä¿ç•™å¿…è¦çš„å…¬å…±ä¾èµ–
2. æŠ½å– service å’Œå®ä½“ç±»
3. install æœ¬åœ° maven åŒ…
4. è®©æœåŠ¡æä¾›è€…å¼•å…¥ common åŒ…ï¼Œæµ‹è¯•æ˜¯å¦æ­£å¸¸è¿è¡Œ
5. è®©æœåŠ¡æ¶ˆè´¹è€…å¼•å…¥ common åŒ…

### [Dubbo](https://www.notion.so/Dubbo-1e452b323dd180d097c5cf4cc4807154?pvs=21)

- å°†å…¬å…±æœåŠ¡æ¥å£æŠ½è±¡åˆ°`qianapi-common` é¡¹ç›®
- `qianapi-backend` é¡¹ç›®å®ç°ä¾‹å¦‚`InnerInterfaceInfoServiceImpl`æ¥å£ï¼Œæ‰“ä¸Š`@DubboService`æ³¨è§£ï¼Œé…ç½®å¦‚ä¸‹
    
    ```yaml
    dubbo:
      application:
        # è®¾ç½®åº”ç”¨çš„åç§°
        name: dubbo-springboot-demo-provider
        qos-enabled: true
        qos-port: 22222
        qos-access-forbidden: false
      # æŒ‡å®šä½¿ç”¨ Dubbo åè®®ï¼Œä¸”ç«¯å£è®¾ç½®ä¸º -1ï¼Œè¡¨ç¤ºéšæœºåˆ†é…å¯ç”¨ç«¯å£
      protocol:
        name: dubbo
        port: 22221
      registry:
        # é…ç½®æ³¨å†Œä¸­å¿ƒä¸º Nacosï¼Œä½¿ç”¨çš„åœ°å€æ˜¯ nacos://localhost:8848
        id: nacos-registry
        address: nacos://localhost:8848
    ```
    
    ```xml
    <dependency>
       <groupId>com.qian</groupId>
       <artifactId>qianapi-common</artifactId>
       <version>0.0.1</version>
    </dependency>
    ```
    
- æ¶ˆè´¹è€…`qianapi-gateway`é¡¹ç›®å¯ä»¥é€šè¿‡dubboç›´æ¥ä½¿ç”¨æä¾›è€…çš„æœåŠ¡
    
    ```java
    @DubboReference
    private InnerUserService innerUserService;
    
    @DubboReference
    private InnerInterfaceInfoService innerInterfaceInfoService;
    
    @DubboReference
    private InnerUserInterfaceInfoService innerUserInterfaceInfoService;
    ```
    

# éƒ¨ç½²

**åç«¯ï¼š**

- backend é¡¹ç›®ï¼šweb é¡¹ç›®ï¼Œéƒ¨ç½² spring boot çš„ jar åŒ…ï¼ˆå¯¹å¤–çš„ï¼‰
- gateway ç½‘å…³é¡¹ç›®ï¼šweb é¡¹ç›®ï¼Œéƒ¨ç½² spring boot çš„ jar åŒ…ï¼ˆå¯¹å¤–çš„ï¼‰
- interface æ¨¡æ‹Ÿæ¥å£é¡¹ç›®ï¼šweb é¡¹ç›®ï¼Œéƒ¨ç½² spring boot çš„ jar åŒ…ï¼ˆä¸å»ºè®®å¯¹å¤–æš´éœ²çš„ï¼‰

```yaml
project-root/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ qianapi-backend-0.0.1-SNAPSHOT.jar
â”‚   â””â”€â”€ Dockerfile
â”œâ”€â”€ gateway/
â”‚   â”œâ”€â”€ gateway-0.0.1-SNAPSHOT.jar
â”‚   â””â”€â”€ Dockerfile
â”œâ”€â”€ interface/
â”‚   â”œâ”€â”€ interface-0.0.1-SNAPSHOT.jar
â”‚   â””â”€â”€ Dockerfile
â””â”€â”€ docker-compose.yml
```

- qianapi-backend dockerfile å…¶ä»–é¡¹ç›®ç±»ä¼¼

```java
# Docker é•œåƒæ„å»º
FROM maven:3.5-jdk-8-alpine as builder

# Copy local code to the container image.
WORKDIR /app
COPY qianapi-backend-0.0.1-SNAPSHOT.jar /app/qianapi-backend-0.0.1-SNAPSHOT.jar

# Run the web service on container startup.
CMD ["java","-jar","/app/qianapi-backend-0.0.1-SNAPSHOT.jar","--spring.profiles.active=prod"]

```

- docker-compose.yml

```yaml
version: '3.8'
services:
  backend:
    build:
      context: ./backend
    container_name: qianapi-backend
    ports:
      - "7529:7529"
    restart: always

  gateway:
    build:
      context: ./gateway
    container_name: qianapi-gateway
    ports:
      - "8090:8090"
    restart: always

  interface:
    build:
      context: ./interface
    container_name: qianapi-interface
    ports:
      - "8123:8123"
    restart: always

```

- æ‰“åŒ…å‘½ä»¤
    
    ```bash
    docker-compose up --build -d
    ```
    
    **âš ï¸ä¸å•ä¸ªæ‰“åŒ…çš„åŒºåˆ«åœ¨äºï¼Œdocker-composeå¯ä»¥ç»Ÿä¸€ç®¡ç†å¤šä¸ª Docker å®¹å™¨æœåŠ¡**
    
     `build` å­—æ®µå°±ç›¸å½“äº
    
    ```bash
    cd backend
    docker build -t qianapi-backend:v0.0.1 .
    ```
    
- å¯åŠ¨docker
    
    ```bash
    docker run -d -p 7529:7529 qianapi-backend
    docker run -d -p 8090:8090 qianapi-gateway
    docker run -d -p 8123:8123 qianapi-interface
    ```